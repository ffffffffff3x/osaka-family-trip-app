<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <!-- åŠ ä¸Š viewport-fit=cover è®“ iPhone å…¨è¢å¹•æ™‚é¿é–‹åŠ‰æµ· -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>OSAKA Family Trip 2025</title>
    
    <!-- iOS Web App è¨­å®š (è®“ç¶²é è®Š App çš„é—œéµ) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Osaka 2025">
    <!-- Android Theme Color -->
    <meta name="theme-color" content="#F5F5F4">

    <!-- App Icon è¨­å®š (æ›´æ–°ç‚ºæ›´ç©©å®šçš„ Icons8 é»ƒè‰²éŠ€æè‘‰åœ–æº) -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://img.icons8.com/fluency/512/ginkgo-leaf.png">
    <link rel="icon" type="image/png" href="https://img.icons8.com/fluency/512/ginkgo-leaf.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Noto+Serif+JP:wght@700&display=swap" rel="stylesheet">

    <!-- Leaflet CSS (åœ°åœ–) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #F5F5F4; /* Stone-100 æ¥µç°¡ç°åº• */
            -webkit-tap-highlight-color: transparent;
            color: #44403c; /* Stone-700 */
            /* iOS Safe Area Support */
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .page {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            padding-bottom: 110px;
        }
        .page.active { display: block; opacity: 1; }

        /* Splash Animation */
        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.8s ease-out;
        }

        .nav-item.active { color: #292524; } /* Stone-800 */
        .nav-item.active svg { stroke-width: 2.5px; }

        .serif-title { font-family: 'Noto Serif JP', serif; }

        /* Cards */
        .driver-card {
            background: linear-gradient(135deg, #292524 0%, #44403c 100%);
            color: white;
        }

        .jp-card {
            transition: transform 0.1s, background-color 0.2s;
        }
        .jp-card:active {
            transform: scale(0.95);
            background-color: #e7e5e4;
        }

        /* Modal & Maps */
        #zoom-modal { backdrop-filter: blur(8px); }
        .leaflet-pane { z-index: 1 !important; }
        .leaflet-control { z-index: 2 !important; }
        
        /* Map Card Background Placeholder */
        .map-card-bg {
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/thumb/6/6f/Osaka_Metro_Route_Map_%28Schema%29.svg/1024px-Osaka_Metro_Route_Map_%28Schema%29.svg.png');
            background-size: cover;
            background-position: center;
            opacity: 0.5;
        }
    </style>
</head>
<body class="antialiased h-screen overflow-hidden">

    <!-- 1. å•Ÿå‹•é  -->
    <div id="splash-screen">
        <div class="text-center animate-pulse px-6">
            <h1 class="text-4xl font-bold tracking-widest text-stone-800 mb-2 serif-title">OSAKA</h1>
            <h2 class="text-lg font-medium tracking-wide text-stone-500 mb-6">Family Trip 2025</h2>
            <div class="w-8 h-0.5 bg-stone-300 mx-auto mb-4"></div>
            <p class="text-xs text-stone-400 tracking-widest font-mono">2025.12.13 - 12.18</p>
        </div>
    </div>

    <!-- 2. è¡Œç¨‹ä¸»é  -->
    <div id="page-flight" class="page h-full overflow-y-auto no-scrollbar">
        <!-- Header (å¯æ›åœ–) -->
        <div class="relative h-60 w-full overflow-hidden z-10 group">
            <img id="daily-scenic-img" src="" class="w-full h-full object-cover transition-opacity duration-700">
            <div class="absolute inset-0 bg-gradient-to-t from-stone-900/70 to-transparent"></div>
            
            <div class="absolute bottom-6 left-6 text-white">
                <div class="flex items-center gap-2 mb-2 opacity-90">
                    <span class="bg-white/20 px-2 py-0.5 rounded text-[10px] font-bold backdrop-blur-sm tracking-wider uppercase">Day <span id="header-day-num">1</span></span>
                </div>
                <h1 class="text-3xl font-bold serif-title tracking-wide">OSAKA Family Trip</h1>
            </div>

            <!-- æ›´æ›å°é¢æŒ‰éˆ• -->
            <label class="absolute bottom-6 right-6 bg-black/30 hover:bg-black/50 text-white p-2 rounded-full cursor-pointer backdrop-blur-md transition-colors">
                <input type="file" accept="image/*" class="hidden" onchange="handleHeaderUpload(event)">
                <i data-lucide="camera" class="w-5 h-5"></i>
            </label>
        </div>

        <!-- æ—¥æœŸå°èˆª -->
        <div class="sticky top-0 bg-[#F5F5F4]/95 backdrop-blur z-30 border-b border-stone-200 shadow-sm mt-[-20px] pt-6 rounded-t-3xl">
            <div class="flex items-center justify-between pl-2 pr-4 py-2">
                <div class="flex overflow-x-auto no-scrollbar space-x-2 py-1 flex-1" id="date-tabs">
                    <!-- Javascript Injected -->
                </div>
                <button onclick="openAddModal()" class="flex-shrink-0 ml-2 bg-stone-800 text-white px-3 py-1.5 rounded-full text-xs font-bold shadow-md active:bg-black flex items-center transition-colors">
                    <i data-lucide="plus" class="w-3.5 h-3.5 mr-1"></i> æ–°å¢
                </button>
            </div>
        </div>

        <!-- å¤©æ°£é å ±æ¢ -->
        <div class="py-3 overflow-x-auto no-scrollbar">
            <div class="flex px-4 space-x-3 min-w-max" id="weather-strip">
                <!-- JS Injected Weather Cards -->
            </div>
        </div>

        <!-- è¡Œç¨‹åˆ—è¡¨ -->
        <div id="itinerary-list" class="p-4 space-y-3 pb-24 min-h-[300px]">
            <div class="text-center py-10 text-stone-300">
                <i data-lucide="loader-2" class="w-6 h-6 mx-auto animate-spin"></i>
            </div>
        </div>
    </div>

    <!-- 3. è¡Œææ¸…å–® -->
    <div id="page-luggage" class="page h-full overflow-y-auto no-scrollbar">
        <div class="sticky top-0 bg-[#F5F5F4]/95 backdrop-blur z-20 border-b border-stone-200 px-5 py-4">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold text-stone-800 serif-title">è¡Œææ¸…å–®</h2>
                <span class="text-xs font-mono bg-stone-200 px-2 py-1 rounded text-stone-600" id="luggage-count">0/0</span>
            </div>
            <div class="w-full bg-stone-200 h-1 mt-3 rounded-full overflow-hidden">
                <div id="progress-bar" class="bg-stone-800 h-full w-0 transition-all duration-500"></div>
            </div>
            <div class="mt-4 flex gap-2">
                <input type="text" id="new-luggage-item" placeholder="æ–°å¢ç‰©å“..." class="flex-1 bg-white border border-stone-200 rounded-lg px-4 py-2 text-sm outline-none focus:border-stone-400 transition-colors">
                <button onclick="addLuggageItem()" class="bg-stone-800 text-white px-4 rounded-lg text-sm font-bold shadow-sm active:scale-95 transition-transform">æ–°å¢</button>
            </div>
        </div>
        <div class="p-5 space-y-2" id="luggage-list"></div>
    </div>

    <!-- 4. è¨˜å¸³ -->
    <div id="page-money" class="page h-full overflow-y-auto no-scrollbar">
        <div class="sticky top-0 bg-[#F5F5F4]/95 backdrop-blur z-20 border-b border-stone-200 px-5 py-4">
             <h2 class="text-xl font-bold text-stone-800 serif-title">æ›åŒ¯ & è¨˜å¸³</h2>
        </div>
        <div class="p-5">
            <!-- ç¨ç«‹è¨ˆç®—æ©Ÿ -->
            <div class="bg-stone-800 text-white rounded-2xl p-6 shadow-xl mb-8 relative overflow-hidden">
                <div class="flex justify-between items-center mb-6 relative z-10">
                     <span class="text-[10px] font-bold tracking-[0.2em] text-stone-400">EXCHANGE</span>
                     <div class="text-[10px] bg-stone-700 px-2 py-1 rounded text-stone-300">Rate: 0.215</div>
                </div>
                <div class="flex items-end mb-4 border-b border-stone-600 pb-2 relative z-10">
                    <span class="text-lg mr-3 font-light text-stone-400">JPY</span>
                    <input type="number" id="jpy-input" placeholder="0" class="w-full bg-transparent text-4xl font-mono outline-none text-white placeholder-stone-600 text-right" oninput="calculateExchange()">
                </div>
                <div class="flex items-end justify-between pt-2 relative z-10">
                    <span class="text-lg font-light text-stone-400">TWD</span>
                    <span class="text-4xl font-mono font-bold text-emerald-400" id="twd-output">0</span>
                </div>
            </div>

            <!-- è¨˜å¸³ -->
            <div class="bg-white p-4 rounded-xl border border-stone-200 shadow-sm mb-6">
                 <div class="flex gap-2 mb-3">
                     <input type="text" id="expense-note" placeholder="é …ç›® (ä¾‹: ç« é­šç‡’)" class="flex-1 bg-stone-50 border-none rounded-lg px-3 py-2.5 text-sm outline-none">
                     <input type="number" id="expense-amt" placeholder="æ—¥å¹£" class="w-24 bg-stone-50 border-none rounded-lg px-3 py-2.5 text-sm outline-none">
                 </div>
                 <button onclick="addExpense()" class="w-full bg-stone-100 text-stone-700 py-3 rounded-lg text-sm font-bold hover:bg-stone-200 transition-colors flex items-center justify-center">
                    <i data-lucide="plus-circle" class="w-4 h-4 mr-2"></i> åŠ å…¥è¨˜å¸³
                 </button>
            </div>
            <div class="flex justify-between items-end mb-3 px-1">
                <h3 class="text-sm font-bold text-stone-600">æ”¯å‡ºæ˜ç´°</h3>
                <div class="text-right cursor-pointer" onclick="toggleTotalCurrency()">
                    <div class="text-[10px] text-stone-400 uppercase">Total Spent</div>
                    <div class="font-mono font-bold text-lg text-stone-800" id="total-expense">Â¥0</div>
                </div>
            </div>
            <div id="expense-list" class="space-y-3 pb-20"></div>
        </div>
    </div>

    <!-- 5. è³‡è¨Š -->
    <div id="page-info" class="page h-full overflow-y-auto no-scrollbar bg-stone-50">
        <div class="sticky top-0 bg-[#F5F5F4]/95 backdrop-blur z-20 border-b border-stone-200 px-5 py-4">
            <h2 class="text-xl font-bold text-stone-800 serif-title">æ—…ç¨‹è³‡è¨Šå¡</h2>
        </div>

        <div class="p-5 space-y-6">
            <!-- æ‰‹æŒ‡å¡ -->
            <div>
                <h3 class="text-xs font-bold text-stone-400 uppercase tracking-wider mb-3 ml-1 flex items-center">
                    <i data-lucide="hand-pointing-right" class="w-3 h-3 mr-1"></i> å¯¦ç”¨æ—¥èªæ‰‹æŒ‡å¡ (ç¦®è²Œç‰ˆ)
                </h3>
                <div class="grid grid-cols-2 gap-3">
                    <div onclick="openZoomCard('çµå¸³', 'ãŠä¼šè¨ˆã‚’ãŠé¡˜ã„ã—ã¾ã™', 'O-kai-kei o o-ne-gai shi-masu')" class="bg-white p-4 rounded-xl border border-stone-200 jp-card cursor-pointer shadow-sm">
                        <div class="text-xs text-stone-400 mb-1">éº»ç…©è«‹çµå¸³</div>
                        <div class="font-bold text-stone-800 text-lg serif-title">ãŠä¼šè¨ˆ...</div>
                    </div>
                    <div onclick="openZoomCard('æ´—æ‰‹é–“', 'ãŠæ‰‹æ´—ã„ã¯ã©ã“ã§ã™ã‹ï¼Ÿ', 'O-te-a-rai wa do-ko de-su-ka')" class="bg-white p-4 rounded-xl border border-stone-200 jp-card cursor-pointer shadow-sm">
                        <div class="text-xs text-stone-400 mb-1">è«‹å•å»æ‰€åœ¨å“ª</div>
                        <div class="font-bold text-stone-800 text-lg serif-title">ãŠæ‰‹æ´—ã„ã¯...</div>
                    </div>
                    <div onclick="openZoomCard('æ°´', 'ãŠæ°´ã‚’ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ', 'O-mi-zu o i-ta-da-ke-ma-su-ka')" class="bg-white p-4 rounded-xl border border-stone-200 jp-card cursor-pointer shadow-sm">
                        <div class="text-xs text-stone-400 mb-1">è«‹çµ¦æˆ‘æ°´</div>
                        <div class="font-bold text-stone-800 text-lg serif-title">ãŠæ°´ã‚’...</div>
                    </div>
                    <div onclick="openZoomCard('å»å†°', 'æ°·ãªã—ã§ãŠé¡˜ã„ã—ã¾ã™', 'Ko-ori na-shi de o-ne-gai shi-ma-su')" class="bg-white p-4 rounded-xl border border-stone-200 jp-card cursor-pointer shadow-sm">
                        <div class="text-xs text-stone-400 mb-1">å»å†° (çµ¦å°å­©)</div>
                        <div class="font-bold text-stone-800 text-lg serif-title">æ°·ãªã—ã§...</div>
                    </div>
                    <!-- ç„¡é…’ç²¾ -->
                    <div onclick="openZoomCard('ç„¡é…’ç²¾è«‹æ±‚', 'å­ä¾›ãŒé£Ÿã¹ã‚‹ã®ã§ã€<br>ãŠé…’ãŒå…¥ã£ã¦ã„ãªã„æ–™ç†ã‚’<br>ãŠé¡˜ã„ã§ãã¾ã™ã‹ï¼Ÿ', 'No Alcohol for kids')" class="col-span-2 bg-orange-50 p-4 rounded-xl border border-orange-100 jp-card cursor-pointer shadow-sm flex items-center justify-between">
                        <div>
                            <div class="text-xs text-orange-400 mb-1 font-bold">çµ¦å°å­©åƒçš„ (ç„¡é…’ç²¾)</div>
                            <div class="font-bold text-stone-800 text-lg serif-title">ãŠé…’ãŒå…¥ã£ã¦ã„ãªã„...</div>
                        </div>
                        <i data-lucide="ban" class="w-6 h-6 text-orange-300"></i>
                    </div>
                </div>
            </div>

            <!-- åœ°éµåœ– -->
            <div class="bg-white rounded-xl overflow-hidden shadow-sm border border-stone-200">
                <div class="p-3 border-b border-stone-100 bg-stone-50 flex justify-between items-center">
                    <h3 class="text-xs font-bold text-stone-600 uppercase tracking-wider flex items-center">
                        <i data-lucide="map" class="w-4 h-4 mr-2"></i> Subway Map
                    </h3>
                    <label class="cursor-pointer bg-white border border-stone-200 px-2 py-1 rounded text-[10px] font-bold text-stone-500 hover:bg-stone-100 transition-colors">
                        æ›´æ›åœ–ç‰‡
                        <input type="file" id="map-upload" accept="image/*" class="hidden" onchange="handleMapUpload(event)">
                    </label>
                </div>
                <div class="overflow-auto max-h-80 bg-stone-100 relative">
                    <img id="user-map-img" src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/6f/Osaka_Metro_Route_Map_%28Schema%29.svg/1024px-Osaka_Metro_Route_Map_%28Schema%29.svg.png" class="w-full object-contain min-h-[200px]">
                </div>
            </div>

            <!-- ä½å®¿æºé€šå¡ -->
            <div class="driver-card rounded-xl p-6 shadow-xl relative overflow-hidden group">
                <div class="relative z-10">
                    <div class="flex items-center mb-4">
                        <span class="bg-white/20 px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider text-white">Taxi Card</span>
                    </div>
                    <h3 class="text-sm text-stone-300 mb-1">ä½ å¥½ï¼Œè«‹è¼‰æˆ‘å»é€™å®¶é£¯åº—</h3>
                    <p class="text-xl font-bold serif-title mb-6 leading-relaxed">é‹è»¢æ‰‹ã•ã‚“ã€<br>ã“ã®ãƒ›ãƒ†ãƒ«ã¾ã§ãŠé¡˜ã„ã—ã¾ã™ã€‚</p>
                    
                    <div class="bg-white/10 p-4 rounded-lg backdrop-blur-sm border border-white/10">
                        <h4 class="font-bold text-lg text-white mb-1">Ostay Vermillion Kitahama</h4>
                        <p class="text-sm text-stone-300 serif-title leading-relaxed">
                            ã€’541-0041<br>
                            å¤§é˜ªåºœå¤§é˜ªå¸‚ä¸­å¤®åŒºåŒ—æµœ 2-4-11
                        </p>
                    </div>
                    <div class="mt-4 flex gap-3">
                         <a href="https://goo.gl/maps/JuA5v7KaqMzoPAxD6" target="_blank" class="flex-1 bg-white text-stone-900 py-2.5 rounded-lg text-xs font-bold text-center flex items-center justify-center hover:bg-stone-200 transition-colors">
                            <i data-lucide="map-pin" class="w-3 h-3 mr-1.5"></i> Google Maps
                         </a>
                    </div>
                </div>
            </div>

            <!-- å‚™å¿˜éŒ„ -->
            <div class="bg-white rounded-xl border border-stone-200 p-4 shadow-sm">
                 <h3 class="text-sm font-bold text-stone-800 mb-3 flex items-center">
                    <i data-lucide="sticky-note" class="w-4 h-4 mr-2"></i> æˆ‘çš„å‚™å¿˜éŒ„
                 </h3>
                 <div class="flex gap-2 mb-3">
                    <input type="text" id="new-note-input" placeholder="ä¾‹ï¼šWifiå¯†ç¢¼..." class="flex-1 bg-stone-50 border border-stone-200 rounded-lg px-3 py-2 text-sm outline-none font-sans">
                    <button onclick="addInfoNote()" class="bg-stone-800 text-white px-3 rounded-lg text-xs font-bold">æ–°å¢</button>
                 </div>
                 <div id="info-notes-list" class="space-y-2 font-sans"></div>
            </div>

            <!-- ç·Šæ€¥å”åŠ© -->
            <div class="pb-10">
                <h3 class="text-xs font-bold text-stone-400 uppercase tracking-wider mb-3 ml-1">ç·Šæ€¥å”åŠ©</h3>
                <div class="grid grid-cols-1 gap-3">
                     <a href="tel:+81662278623" class="flex items-center p-4 bg-white border border-stone-200 rounded-xl shadow-sm active:bg-stone-50">
                        <div class="bg-blue-100 p-2.5 rounded-full mr-4">
                            <i data-lucide="building-2" class="w-5 h-5 text-blue-700"></i>
                        </div>
                        <div>
                            <div class="font-bold text-sm text-stone-800">å°åŒ—é§å¤§é˜ªç¶“æ¿Ÿæ–‡åŒ–è¾¦äº‹è™•</div>
                            <div class="text-xs text-stone-500">+81-6-6227-8623</div>
                        </div>
                    </a>
                </div>
                <div class="grid grid-cols-2 gap-3 mt-3">
                    <a href="tel:110" class="flex items-center p-3 bg-white border border-red-100 rounded-xl shadow-sm active:bg-red-50">
                        <div class="bg-red-100 p-2 rounded-full mr-3"><i data-lucide="phone" class="w-4 h-4 text-red-600"></i></div>
                        <span class="font-bold text-sm text-stone-800">å ±è­¦ 110</span>
                    </a>
                    <a href="tel:119" class="flex items-center p-3 bg-white border border-green-100 rounded-xl shadow-sm active:bg-green-50">
                        <div class="bg-green-100 p-2 rounded-full mr-3"><i data-lucide="ambulance" class="w-4 h-4 text-green-600"></i></div>
                        <span class="font-bold text-sm text-stone-800">æ€¥æ•‘ 119</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- 6. æ”¾å¤§æ‰‹æŒ‡å¡ Modal -->
    <div id="zoom-modal" class="fixed inset-0 bg-black/90 z-[200] hidden flex flex-col justify-center items-center p-6 animate-fade-in" onclick="closeZoomCard()">
        <div class="text-white text-center w-full max-w-lg" onclick="event.stopPropagation()">
            <h3 id="zoom-title" class="text-stone-400 text-sm font-bold uppercase tracking-widest mb-6">TITLE</h3>
            <div id="zoom-jp" class="text-4xl sm:text-5xl font-bold serif-title leading-snug mb-6 text-white">
                æ—¥æœ¬èª
            </div>
            <div id="zoom-ro" class="text-stone-400 font-mono text-sm mb-12">
                Romaji
            </div>
            <button onclick="closeZoomCard()" class="px-8 py-3 rounded-full border border-white/30 text-white text-sm hover:bg-white/10 transition-colors">
                é—œé–‰ (Close)
            </button>
        </div>
    </div>

    <!-- åº•éƒ¨å°èˆª -->
    <nav class="fixed bottom-0 w-full bg-[#F5F5F4]/95 backdrop-blur border-t border-stone-200 pb-safe z-50 rounded-t-xl shadow-[0_-5px_20px_rgba(0,0,0,0.02)]">
        <div class="flex justify-around items-center h-20 pb-2">
            <button onclick="switchPage('flight')" class="nav-item active flex flex-col items-center justify-center w-full text-stone-300 transition-colors" id="nav-flight">
                <i data-lucide="calendar-days" class="w-6 h-6 mb-1"></i>
                <span class="text-[10px] font-medium">è¡Œç¨‹</span>
            </button>
            <button onclick="switchPage('luggage')" class="nav-item flex flex-col items-center justify-center w-full text-stone-300 transition-colors" id="nav-luggage">
                <i data-lucide="briefcase" class="w-6 h-6 mb-1"></i>
                <span class="text-[10px] font-medium">è¡Œæ</span>
            </button>
            <button onclick="switchPage('money')" class="nav-item flex flex-col items-center justify-center w-full text-stone-300 transition-colors" id="nav-money">
                <i data-lucide="wallet" class="w-6 h-6 mb-1"></i>
                <span class="text-[10px] font-medium">éŒ¢åŒ…</span>
            </button>
            <button onclick="switchPage('info')" class="nav-item flex flex-col items-center justify-center w-full text-stone-300 transition-colors" id="nav-info">
                <i data-lucide="info" class="w-6 h-6 mb-1"></i>
                <span class="text-[10px] font-medium">è³‡è¨Š</span>
            </button>
        </div>
    </nav>

    <!-- Modal: æ–°å¢/ä¿®æ”¹è¡Œç¨‹ -->
    <div id="add-modal" class="fixed inset-0 bg-stone-900/60 z-[100] hidden flex items-end sm:items-center justify-center sm:p-4 backdrop-blur-sm">
        <div class="bg-white rounded-t-2xl sm:rounded-2xl w-full max-w-sm p-6 shadow-2xl animate-slide-up">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-stone-800" id="modal-title">æ–°å¢è¡Œç¨‹</h3>
                <button onclick="closeAddModal()" class="p-2 bg-stone-100 rounded-full hover:bg-stone-200"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            
            <input type="hidden" id="edit-id" value="">

            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-bold text-stone-400 uppercase tracking-wider mb-1 block">æ¨™é¡Œ / é¡¯ç¤ºåç¨±</label>
                    <input type="text" id="new-title" placeholder="ä¾‹ï¼šåˆé¤" class="w-full border-b border-stone-200 py-2 text-stone-800 outline-none focus:border-stone-800 bg-transparent text-lg placeholder-stone-300 font-sans">
                </div>
                
                 <div>
                    <label class="text-[10px] font-bold text-stone-400 uppercase tracking-wider mb-1 block">åœ°åœ–å®šä½ (Google Maps é—œéµå­—)</label>
                    <input type="text" id="new-location" placeholder="ä¾‹ï¼šæ•˜æ•˜è‹‘ æ¸¸ç„äº­" class="w-full border-b border-stone-200 py-2 text-stone-600 outline-none focus:border-stone-800 bg-transparent text-sm placeholder-stone-300 font-sans">
                    <p class="text-[10px] text-stone-400 mt-1">* è¼¸å…¥ç²¾ç¢ºåœ°å€æˆ–åº—åï¼Œå°èˆªæ›´æº–ç¢º</p>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] font-bold text-stone-400 uppercase tracking-wider mb-1 block">æ™‚é–“</label>
                        <input type="time" id="new-time" class="w-full border-b border-stone-200 py-2 text-stone-800 outline-none focus:border-stone-800 bg-transparent font-mono">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-stone-400 uppercase tracking-wider mb-1 block">æ—¥æœŸ</label>
                        <select id="new-day" class="w-full border-b border-stone-200 py-2 text-stone-800 outline-none bg-transparent">
                            <!-- JS Generated -->
                        </select>
                    </div>
                </div>

                <div>
                    <label class="text-[10px] font-bold text-stone-400 uppercase tracking-wider mb-3 block">åˆ†é¡</label>
                    <div class="grid grid-cols-4 gap-2">
                        <label class="cursor-pointer">
                            <input type="radio" name="new-type" value="food" class="peer hidden" checked>
                            <div class="flex flex-col items-center justify-center p-2 bg-stone-50 rounded-lg border border-stone-100 peer-checked:bg-orange-100 peer-checked:text-orange-700 transition-all">
                                <i data-lucide="utensils" class="w-4 h-4"></i>
                                <span class="text-[10px] mt-1 font-bold">ç¾é£Ÿ</span>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="new-type" value="spot" class="peer hidden">
                            <div class="flex flex-col items-center justify-center p-2 bg-stone-50 rounded-lg border border-stone-100 peer-checked:bg-stone-200 peer-checked:text-stone-800 transition-all">
                                <i data-lucide="map-pin" class="w-4 h-4"></i>
                                <span class="text-[10px] mt-1 font-bold">æ™¯é»</span>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="new-type" value="shop" class="peer hidden">
                            <div class="flex flex-col items-center justify-center p-2 bg-stone-50 rounded-lg border border-stone-100 peer-checked:bg-sky-100 peer-checked:text-sky-700 transition-all">
                                <i data-lucide="shopping-bag" class="w-4 h-4"></i>
                                <span class="text-[10px] mt-1 font-bold">è³¼ç‰©</span>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="new-type" value="flight" class="peer hidden">
                            <div class="flex flex-col items-center justify-center p-2 bg-stone-50 rounded-lg border border-stone-100 peer-checked:bg-stone-200 peer-checked:text-stone-700 transition-all">
                                <i data-lucide="plane" class="w-4 h-4"></i>
                                <span class="text-[10px] mt-1 font-bold">é£›è¡Œ</span>
                            </div>
                        </label>
                    </div>
                </div>
            </div>

            <button onclick="saveItineraryItem()" class="mt-8 w-full py-3.5 rounded-xl bg-stone-800 text-white font-bold shadow-lg hover:bg-black active:scale-[0.98] transition-all flex items-center justify-center">
                <i data-lucide="check" class="w-4 h-4 mr-2"></i> <span id="modal-btn-text">ç¢ºèªæ–°å¢</span>
            </button>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- CONFIG ---
        const firebaseConfig = JSON.parse(new URLSearchParams(window.location.search).get('firebase_config') || '{}');
        const appId = 'osaka-2025-v4-map';
        let db, auth, userId;

        // Date: 2025/12/13 (Sat)
        const TRIP_START = new Date('2025-12-13T00:00:00');
        const TOTAL_DAYS = 6;
        const WEEKDAYS = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        
        // Scenic Images (éŠ€æ & æ¥“è‘‰)
        const SCENIC_IMAGES = [
            "https://images.unsplash.com/photo-1542051841857-5f90071e7989?q=80&w=1200&auto=format&fit=crop", 
            "https://images.unsplash.com/photo-1505337833003-88220268523c?q=80&w=1200&auto=format&fit=crop", 
            "https://images.unsplash.com/photo-1478436127897-769e1b3f0f36?q=80&w=1200&auto=format&fit=crop", 
            "https://images.unsplash.com/photo-1476514525535-07fb3b4ae5f1?q=80&w=1200&auto=format&fit=crop", 
            "https://images.unsplash.com/photo-1572975765715-288219662e08?q=80&w=1200&auto=format&fit=crop", 
            "https://images.unsplash.com/photo-1605626993138-03822295696d?q=80&w=1200&auto=format&fit=crop"
        ];
        
        let userHeaderImage = null; // Store user uploaded image data URL

        const WEATHER_DATA = [
            { icon: 'â›…', temp: '8Â° / 14Â°', rain: '10%' },
            { icon: 'â˜€ï¸', temp: '7Â° / 15Â°', rain: '0%' },
            { icon: 'â˜€ï¸', temp: '6Â° / 13Â°', rain: '0%' },
            { icon: 'â˜ï¸', temp: '8Â° / 12Â°', rain: '20%' },
            { icon: 'ğŸŒ§ï¸', temp: '5Â° / 10Â°', rain: '60%' },
            { icon: 'â›…', temp: '6Â° / 13Â°', rain: '10%' }
        ];

        let currentDayIndex = 0; 
        let mapInstance = null;

        // Default Itinerary with REAL Coordinates for Leaflet
        const DEFAULT_ITINERARY = [
            { id: 'd1_1', day: 0, time: '15:25', title: 'KHH é«˜é›„èµ·é£› (CI 176)', type: 'flight', location: 'é«˜é›„å°æ¸¯æ©Ÿå ´', lat: 22.57, lng: 120.35 },
            { id: 'd1_2', day: 0, time: '19:10', title: 'æŠµé”é—œè¥¿æ©Ÿå ´ (KIX)', type: 'flight', location: 'é—œè¥¿åœ‹éš›æ©Ÿå ´', lat: 34.434, lng: 135.235 },
            { id: 'd1_3', day: 0, time: '20:30', title: 'å‰å¾€é£¯åº— Check-in', type: 'spot', location: 'Ostay Vermillion Kitahama', lat: 34.691, lng: 135.506 },
            { id: 'd2_1', day: 1, time: '10:00', title: 'å¤§é˜ªåŸå…¬åœ’', type: 'spot', location: 'å¤§é˜ªåŸå…¬åœ’', lat: 34.687, lng: 135.526 },
            { id: 'd2_2', day: 1, time: '12:00', title: 'åˆé¤: å¤§é˜ªåŸå‘¨é‚Š', type: 'food', location: 'Jo-Terrace Osaka', lat: 34.689, lng: 135.531 },
            { id: 'd3_1', day: 2, time: '10:00', title: 'éºµåŒ…è¶…äººåšç‰©é¤¨', type: 'spot', location: 'ç¥æˆ¶éºµåŒ…è¶…äººå…’ç«¥åšç‰©é¤¨', lat: 34.680, lng: 135.186 },
            { id: 'd3_2', day: 2, time: '13:00', title: 'é¦¬è³½å…‹å»£å ´åˆé¤', type: 'food', location: 'Mosaic Kobe', lat: 34.679, lng: 135.185 },
            { id: 'd4_1', day: 3, time: '11:00', title: 'æ¢…ç”°è³¼ç‰©é€›è¡—', type: 'shop', location: 'Grand Front Osaka', lat: 34.704, lng: 135.495 },
            { id: 'd4_2', day: 3, time: '18:00', title: 'æ¢…ç”°è—å¤©å¤§å»ˆå¤œæ™¯', type: 'spot', location: 'æ¢…ç”°è—å¤©å¤§å»ˆ', lat: 34.705, lng: 135.490 },
            { id: 'd5_1', day: 4, time: '09:00', title: 'å‰å¾€äº¬éƒ½', type: 'spot', location: 'Kyoto Station', lat: 34.985, lng: 135.758 },
            { id: 'd5_2', day: 4, time: '10:30', title: 'æ¸…æ°´å¯º & äºŒä¸‰å¹´å‚', type: 'spot', location: 'æ¸…æ°´å¯º', lat: 34.994, lng: 135.785 },
            { id: 'd5_3', day: 4, time: '18:00', title: 'è¿”å›å¤§é˜ª', type: 'spot', location: 'Ostay Vermillion Kitahama', lat: 34.691, lng: 135.506 },
            { id: 'd6_1', day: 5, time: '17:30', title: 'å‰å¾€é—œè¥¿æ©Ÿå ´', type: 'spot', location: 'Kansai Airport', lat: 34.434, lng: 135.235 },
            { id: 'd6_2', day: 5, time: '20:10', title: 'KIX èµ·é£› (CI 177)', type: 'flight', location: 'Kansai Airport', lat: 34.434, lng: 135.235 },
            { id: 'd6_3', day: 5, time: '22:45', title: 'æŠµé”é«˜é›„ (KHH)', type: 'flight', location: 'Kaohsiung Airport', lat: 22.57, lng: 120.35 }
        ];

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', async () => {
            lucide.createIcons();
            initDateTabs();
            initWeather();
            initLuggage();
            initExpenses();
            initInfoNotes();

            if (typeof firebase !== 'undefined' && firebaseConfig.apiKey) {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();
                try {
                    const cred = await auth.signInAnonymously();
                    userId = cred.user.uid;
                    setupItineraryListener();
                } catch(e) { renderLocalItinerary(); }
            } else {
                userId = 'local-user';
                renderLocalItinerary();
            }

            setTimeout(() => {
                document.getElementById('splash-screen').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('splash-screen').style.display = 'none';
                    document.getElementById('page-flight').classList.add('active');
                    // Force render again to ensure map container exists
                    renderItineraryList();
                }, 800);
            }, 2500);
        });

        // --- NAV ---
        function switchPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + pageId).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(n => {
                n.classList.remove('active', 'text-stone-800');
                n.classList.add('text-stone-300');
            });
            const btn = document.getElementById('nav-' + pageId);
            btn.classList.add('active', 'text-stone-800');
            btn.classList.remove('text-stone-300');
            lucide.createIcons();
            
            // Fix map size when switching back
            if(pageId === 'flight' && mapInstance) {
                setTimeout(() => mapInstance.invalidateSize(), 100);
            }
        }

        // --- WEATHER UI ---
        function initWeather() {
            const container = document.getElementById('weather-strip');
            WEATHER_DATA.forEach((w, i) => {
                const date = new Date(TRIP_START);
                date.setDate(TRIP_START.getDate() + i);
                const isToday = i === currentDayIndex;
                const week = WEEKDAYS[date.getDay()];
                
                const el = document.createElement('div');
                el.className = `weather-card flex flex-col items-center justify-center p-2 rounded-lg min-w-[70px] border transition-all cursor-pointer ${isToday ? 'bg-white border-stone-300 shadow-sm' : 'bg-transparent border-transparent opacity-60'}`;
                el.onclick = () => setDay(i);
                el.innerHTML = `
                    <span class="text-[10px] font-bold text-stone-400 mb-1">${date.getMonth()+1}/${date.getDate()} (${week})</span>
                    <span class="text-xl mb-1">${w.icon}</span>
                    <span class="text-[10px] font-bold text-stone-600">${w.temp}</span>
                `;
                el.id = `weather-card-${i}`;
                container.appendChild(el);
            });
        }

        function updateWeatherHighlight(index) {
            document.querySelectorAll('.weather-card').forEach((el, i) => {
                if(i === index) {
                    el.className = 'weather-card flex flex-col items-center justify-center p-2 rounded-lg min-w-[70px] border transition-all cursor-pointer bg-white border-stone-300 shadow-sm transform scale-105';
                } else {
                    el.className = 'weather-card flex flex-col items-center justify-center p-2 rounded-lg min-w-[70px] border transition-all cursor-pointer bg-transparent border-transparent opacity-60';
                }
            });
        }

        // --- ITINERARY ---
        function initDateTabs() {
            const container = document.getElementById('date-tabs');
            const select = document.getElementById('new-day');
            
            for(let i=0; i<TOTAL_DAYS; i++) {
                const date = new Date(TRIP_START);
                date.setDate(TRIP_START.getDate() + i);
                const month = date.getMonth() + 1;
                const day = date.getDate();
                const week = WEEKDAYS[date.getDay()];
                
                const btn = document.createElement('button');
                btn.className = `date-tab flex-shrink-0 px-4 py-1.5 rounded-full text-xs font-bold border transition-all ${i===0 ? 'bg-stone-800 text-white border-stone-800' : 'bg-white text-stone-400 border-stone-200'}`;
                btn.innerText = `Day ${i+1} (${week})`;
                btn.onclick = () => setDay(i);
                container.appendChild(btn);

                const opt = document.createElement('option');
                opt.value = i;
                opt.text = `Day ${i+1} - ${month}/${day} (${week})`;
                select.appendChild(opt);
            }
            updateHeaderImage(0);
        }

        function handleHeaderUpload(event) {
            const file = event.target.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    userHeaderImage = e.target.result;
                    document.getElementById('daily-scenic-img').src = userHeaderImage;
                }
                reader.readAsDataURL(file);
            }
        }

        function updateHeaderImage(index) {
            const img = document.getElementById('daily-scenic-img');
            img.style.opacity = '0';
            setTimeout(() => {
                if(userHeaderImage) {
                    img.src = userHeaderImage;
                } else {
                    img.src = SCENIC_IMAGES[index % SCENIC_IMAGES.length];
                }
                img.onload = () => img.style.opacity = '1';
            }, 300);
        }

        function setDay(index) {
            currentDayIndex = index;
            document.querySelectorAll('.date-tab').forEach((t, i) => {
                t.className = i === index 
                    ? 'date-tab flex-shrink-0 px-4 py-1.5 rounded-full text-xs font-bold border transition-all bg-stone-800 text-white border-stone-800 shadow-md'
                    : 'date-tab flex-shrink-0 px-4 py-1.5 rounded-full text-xs font-bold border transition-all bg-white text-stone-400 border-stone-200';
            });
            
            document.getElementById('header-day-num').innerText = index + 1;
            updateHeaderImage(index);
            updateWeatherHighlight(index);
            renderItineraryList();
        }

        let itineraryCache = [];
        
        function setupItineraryListener() {
            if (!db || !userId) return;
            db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('itinerary')
              .onSnapshot(snap => {
                  const fetched = snap.docs.map(d => ({id: d.id, ...d.data()}));
                  if(fetched.length === 0) {
                      DEFAULT_ITINERARY.forEach(async f => {
                          await db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('itinerary').add({...f, created: Date.now()});
                      });
                  } else {
                      itineraryCache = fetched;
                      renderItineraryList();
                  }
              });
        }

        function renderLocalItinerary() {
            if(itineraryCache.length === 0) itineraryCache = [...DEFAULT_ITINERARY];
            renderItineraryList();
        }

        function renderItineraryList() {
            const list = document.getElementById('itinerary-list');
            list.innerHTML = '';
            
            const dayItems = itineraryCache
                .filter(i => parseInt(i.day) === currentDayIndex)
                .sort((a,b) => a.time.localeCompare(b.time));

            if(dayItems.length === 0) {
                list.innerHTML = `<div class="text-center py-10 opacity-30"><p class="text-xs">å°šç„¡è¡Œç¨‹</p></div>`;
                return;
            }

            // 1. Render Items
            dayItems.forEach(item => {
                let bgClass = 'bg-white border-stone-100';
                let iconColor = 'text-stone-300';
                let typeIcon = 'map-pin';
                
                if (item.type === 'food') {
                    bgClass = 'bg-orange-50/50 border-orange-100'; 
                    iconColor = 'text-orange-400';
                    typeIcon = 'utensils';
                } else if (item.type === 'shop') {
                    bgClass = 'bg-sky-50/50 border-sky-100'; 
                    iconColor = 'text-sky-400';
                    typeIcon = 'shopping-bag';
                } else if (item.type === 'flight') {
                    bgClass = 'bg-stone-100 border-stone-200';
                    iconColor = 'text-stone-400';
                    typeIcon = 'plane';
                }

                const query = item.location || item.title;
                const mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`;

                const el = document.createElement('div');
                el.className = `flex items-center p-4 rounded-xl border ${bgClass} relative group transition-all mb-2 shadow-sm`;
                el.innerHTML = `
                    <div class="mr-4 text-center min-w-[3.5rem]">
                        <div class="text-lg font-bold font-mono text-stone-800 leading-none">${item.time}</div>
                    </div>
                    <div class="flex-1 border-l border-stone-200 pl-4 py-1">
                        <div class="flex justify-between items-start">
                             <h3 class="font-bold text-stone-800 text-sm">${item.title}</h3>
                        </div>
                        <div class="flex items-center mt-1">
                            <i data-lucide="${typeIcon}" class="w-3 h-3 mr-1.5 ${iconColor}"></i>
                            <span class="text-[10px] text-stone-400 uppercase tracking-wider font-bold">${item.type}</span>
                            ${item.location && item.location !== item.title ? `<span class="ml-2 text-[10px] text-stone-300 truncate max-w-[100px]"><i data-lucide="map-pin" class="inline w-2 h-2"></i> ${item.location}</span>` : ''}
                        </div>
                    </div>
                    <div class="flex flex-col gap-2 ml-2">
                         <a href="${mapUrl}" target="_blank" class="p-2 bg-white border border-stone-100 rounded-full text-stone-400 hover:text-blue-600 shadow-sm"><i data-lucide="navigation" class="w-4 h-4"></i></a>
                         <div class="flex gap-1">
                             <button onclick="openEditModal('${item.id}')" class="p-2 bg-white border border-stone-100 rounded-full text-stone-400 hover:text-stone-800 shadow-sm"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                             <button onclick="deleteItinerary('${item.id}')" class="p-2 bg-white border border-stone-100 rounded-full text-stone-400 hover:text-red-500 shadow-sm"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                         </div>
                    </div>
                `;
                list.appendChild(el);
            });
            
            // 2. Render Interactive Map Card
            // Only show map if there are spots with coords (mocked for now for default items)
            const mapItems = dayItems.filter(i => i.lat && i.lng);
            
            // Container for Map (Interactive)
            const mapContainer = document.createElement('div');
            mapContainer.className = "mt-6 overflow-hidden rounded-2xl shadow-md border border-stone-200 bg-white";
            // Important: Give it an explicit height
            mapContainer.innerHTML = `
                <div class="h-64 w-full relative z-0" id="map-wrap-${currentDayIndex}"></div>
                <div class="p-3 bg-white text-center border-t border-stone-100">
                    <a href="#" id="google-maps-btn" target="_blank" class="block w-full py-2 bg-blue-50 text-blue-600 rounded-lg text-xs font-bold hover:bg-blue-100 transition-colors">
                        <i data-lucide="external-link" class="w-3 h-3 inline mr-1"></i> é–‹å•Ÿ Google Maps å°èˆª
                    </a>
                </div>
            `;
            list.appendChild(mapContainer);

            // Initialize Leaflet
            setTimeout(() => {
                const mapId = `map-wrap-${currentDayIndex}`;
                const element = document.getElementById(mapId);
                if (element) {
                    if (mapInstance) {
                        mapInstance.remove();
                        mapInstance = null;
                    }
                    
                    // Default center (Osaka)
                    const center = mapItems.length > 0 ? [mapItems[0].lat, mapItems[0].lng] : [34.6937, 135.5023];
                    mapInstance = L.map(mapId).setView(center, 13);

                    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                        attribution: '&copy; OpenStreetMap &copy; CARTO',
                        subdomains: 'abcd',
                        maxZoom: 19
                    }).addTo(mapInstance);

                    if (mapItems.length > 0) {
                        const bounds = [];
                        mapItems.forEach((item, idx) => {
                            const marker = L.marker([item.lat, item.lng])
                                .addTo(mapInstance)
                                .bindPopup(`<b style="font-family:'Noto Sans TC'">${item.time} ${item.title}</b>`);
                            bounds.push([item.lat, item.lng]);
                        });
                        // Fit bounds to show all markers
                        if (bounds.length > 1) {
                            mapInstance.fitBounds(bounds, { padding: [50, 50] });
                        }
                        
                        // Update Google Maps Link with all points
                        const query = mapItems.map(i => i.title).join('/');
                        document.getElementById('google-maps-btn').href = `https://www.google.com/maps/dir/${query}`;
                    } else {
                         // Fallback Google link
                         document.getElementById('google-maps-btn').href = `https://www.google.com/maps/search/Osaka`;
                    }
                }
            }, 100);

            lucide.createIcons();
        }

        // --- MODAL (ADD & EDIT) ---
        function openAddModal() { 
            document.getElementById('add-modal').classList.remove('hidden'); 
            document.getElementById('new-day').value = currentDayIndex;
            document.getElementById('modal-title').innerText = "æ–°å¢è¡Œç¨‹";
            document.getElementById('modal-btn-text').innerText = "ç¢ºèªæ–°å¢";
            document.getElementById('edit-id').value = ""; 
            
            // Clear inputs
            document.getElementById('new-title').value = "";
            document.getElementById('new-location').value = "";
            document.getElementById('new-time').value = "";
        }

        function openEditModal(id) {
            const item = itineraryCache.find(i => i.id === id);
            if(!item) return;

            document.getElementById('add-modal').classList.remove('hidden');
            document.getElementById('modal-title').innerText = "ä¿®æ”¹è¡Œç¨‹";
            document.getElementById('modal-btn-text').innerText = "å„²å­˜ä¿®æ”¹";
            document.getElementById('edit-id').value = id;

            document.getElementById('new-title').value = item.title;
            document.getElementById('new-location').value = item.location || "";
            document.getElementById('new-time').value = item.time;
            document.getElementById('new-day').value = item.day;
            
            const radios = document.getElementsByName('new-type');
            for(let r of radios) {
                if(r.value === item.type) r.checked = true;
            }
        }

        function closeAddModal() { document.getElementById('add-modal').classList.add('hidden'); }
        
        async function saveItineraryItem() {
            const id = document.getElementById('edit-id').value;
            const title = document.getElementById('new-title').value;
            const location = document.getElementById('new-location').value;
            const time = document.getElementById('new-time').value;
            const day = parseInt(document.getElementById('new-day').value);
            const type = document.querySelector('input[name="new-type"]:checked').value;
            
            if(!title || !time) return alert('è«‹å¡«å¯«å®Œæ•´');
            
            // Note: For real lat/lng from user input, you'd need a geocoding API. 
            // Here we save the data, but new user points won't show on the interactive map until geocoded.
            const itemData = { title, location: location || title, time, day, type, created: Date.now() };

            if(db && userId) {
                if(id) {
                    await db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('itinerary').doc(id).update(itemData);
                } else {
                    await db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('itinerary').add(itemData);
                }
            } else {
                if(id) {
                    itineraryCache = itineraryCache.map(i => i.id === id ? { ...i, ...itemData, id } : i);
                } else {
                    itineraryCache.push({ id: Date.now().toString(), ...itemData });
                }
                renderItineraryList();
            }
            closeAddModal();
        }

        async function deleteItinerary(id) {
            if(!confirm('ç¢ºèªåˆªé™¤æ­¤è¡Œç¨‹ï¼Ÿ')) return;
            if(db && userId) {
                await db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('itinerary').doc(id).delete();
            } else {
                itineraryCache = itineraryCache.filter(i => i.id !== id);
                renderItineraryList();
            }
        }

        // --- ZOOM CARD LOGIC ---
        function openZoomCard(title, jp, ro) {
            document.getElementById('zoom-modal').classList.remove('hidden');
            document.getElementById('zoom-modal').classList.add('flex');
            document.getElementById('zoom-title').innerText = title;
            document.getElementById('zoom-jp').innerHTML = jp;
            document.getElementById('zoom-ro').innerText = ro;
        }

        function closeZoomCard() {
            document.getElementById('zoom-modal').classList.add('hidden');
            document.getElementById('zoom-modal').classList.remove('flex');
        }

        // --- MAP UPLOAD LOGIC ---
        function handleMapUpload(event) {
            const file = event.target.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('user-map-img').src = e.target.result;
                }
                reader.readAsDataURL(file);
            }
        }

        // --- INFO NOTES ---
        let infoNotes = [];
        function initInfoNotes() {
            const saved = localStorage.getItem('osaka_notes_2025');
            infoNotes = saved ? JSON.parse(saved) : [];
            renderInfoNotes();
        }
        function renderInfoNotes() {
            const list = document.getElementById('info-notes-list');
            list.innerHTML = '';
            infoNotes.forEach(note => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-3 bg-stone-50 rounded-lg text-sm border border-stone-100 group';
                div.innerHTML = `
                    <span class="text-stone-700">${note.text}</span>
                    <button onclick="deleteInfoNote(${note.id})" class="text-stone-300 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity"><i data-lucide="x" class="w-4 h-4"></i></button>
                `;
                list.appendChild(div);
            });
            localStorage.setItem('osaka_notes_2025', JSON.stringify(infoNotes));
            lucide.createIcons();
        }
        function addInfoNote() {
            const val = document.getElementById('new-note-input').value;
            if(!val) return;
            infoNotes.push({ id: Date.now(), text: val });
            document.getElementById('new-note-input').value = '';
            renderInfoNotes();
        }
        function deleteInfoNote(id) {
            infoNotes = infoNotes.filter(n => n.id !== id);
            renderInfoNotes();
        }

        // --- LUGGAGE ---
        let luggageData = [];
        function initLuggage() {
            const saved = localStorage.getItem('osaka_luggage_2025_v2');
            luggageData = saved ? JSON.parse(saved) : [
                { id: 1, text: 'è­·ç…§ (æœ‰æ•ˆæœŸé™å…§)', checked: false },
                { id: 2, text: 'Visit Japan Web QR', checked: false },
                { id: 3, text: 'ç¶²å¡ / Wifiæ©Ÿ', checked: false },
                { id: 4, text: 'æ—¥å¹£ç¾é‡‘', checked: false }
            ];
            renderLuggage();
        }
        function renderLuggage() {
            const container = document.getElementById('luggage-list');
            container.innerHTML = '';
            const done = luggageData.filter(i => i.checked).length;
            document.getElementById('luggage-count').innerText = `${done}/${luggageData.length}`;
            document.getElementById('progress-bar').style.width = luggageData.length ? (done/luggageData.length)*100 + '%' : '0%';
            luggageData.forEach(item => {
                const el = document.createElement('div');
                el.className = 'flex items-center justify-between p-3 bg-white border border-stone-200 rounded-lg group hover:shadow-sm transition-all';
                el.innerHTML = `
                    <label class="flex items-center flex-1 cursor-pointer select-none">
                        <input type="checkbox" class="w-5 h-5 rounded border-stone-300 text-stone-800 focus:ring-stone-500 mr-3" 
                            ${item.checked ? 'checked' : ''} onchange="toggleLuggage(${item.id})">
                        <span class="${item.checked ? 'line-through text-stone-300' : 'text-stone-700'} text-sm font-medium transition-colors">${item.text}</span>
                    </label>
                    <button onclick="deleteLuggage(${item.id})" class="opacity-0 group-hover:opacity-100 text-stone-300 hover:text-red-400 transition-all px-2"><i data-lucide="x" class="w-4 h-4"></i></button>
                `;
                container.appendChild(el);
            });
            lucide.createIcons();
            localStorage.setItem('osaka_luggage_2025_v2', JSON.stringify(luggageData));
        }
        function toggleLuggage(id) { luggageData = luggageData.map(i => i.id === id ? {...i, checked: !i.checked} : i); renderLuggage(); }
        function addLuggageItem() { const val = document.getElementById('new-luggage-item').value; if(val) { luggageData.push({id:Date.now(), text:val, checked:false}); document.getElementById('new-luggage-item').value=''; renderLuggage(); } }
        function deleteLuggage(id) { luggageData = luggageData.filter(i => i.id !== id); renderLuggage(); }

        // --- EXPENSES ---
        let expenseList = [];
        let showTotalInTWD = false;
        function initExpenses() {
            const saved = localStorage.getItem('osaka_expenses_2025');
            if(saved) expenseList = JSON.parse(saved);
            renderExpenses();
        }
        function calculateExchange() {
            const jpy = parseFloat(document.getElementById('jpy-input').value) || 0;
            document.getElementById('twd-output').innerText = Math.round(jpy * 0.215).toLocaleString();
        }
        function addExpense() {
            const note = document.getElementById('expense-note').value;
            const amt = parseInt(document.getElementById('expense-amt').value);
            if(note && !isNaN(amt)) {
                expenseList.unshift({ id: Date.now(), note, amt });
                document.getElementById('expense-note').value = '';
                document.getElementById('expense-amt').value = '';
                renderExpenses();
            }
        }
        function deleteExpense(id) { expenseList = expenseList.filter(e => e.id !== id); renderExpenses(); }
        function renderExpenses() {
            const container = document.getElementById('expense-list');
            container.innerHTML = '';
            let totalJPY = 0;
            expenseList.forEach(e => {
                totalJPY += e.amt;
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center py-3 border-b border-stone-100 last:border-0';
                div.innerHTML = `
                    <div class="flex items-center">
                        <button onclick="deleteExpense(${e.id})" class="mr-3 text-stone-200 hover:text-red-400"><i data-lucide="minus-circle" class="w-4 h-4"></i></button>
                        <span class="text-sm text-stone-700 font-medium">${e.note}</span>
                    </div>
                    <span class="font-mono text-stone-600 font-bold tracking-tight">Â¥${e.amt.toLocaleString()}</span>
                `;
                container.appendChild(div);
            });
            const totalEl = document.getElementById('total-expense');
            totalEl.innerText = showTotalInTWD ? `NT$ ${Math.round(totalJPY * 0.215).toLocaleString()}` : `Â¥ ${totalJPY.toLocaleString()}`;
            totalEl.className = showTotalInTWD ? 'font-mono font-bold text-lg text-stone-500' : 'font-mono font-bold text-lg text-stone-800';
            localStorage.setItem('osaka_expenses_2025', JSON.stringify(expenseList));
            lucide.createIcons();
        }
        function toggleTotalCurrency() { showTotalInTWD = !showTotalInTWD; renderExpenses(); }
    </script>
</body>
</html>