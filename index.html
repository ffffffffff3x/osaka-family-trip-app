<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>OSAKA Family Trip 2025</title>
    
    <!-- iOS PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#F5F5F4">

    <!-- Icons: Minimalist Black Heart for Browser Tab & PWA -->
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iYmxhY2siPjxwYXRoIGQ9Ik0xMiAyMS4zNWwtMS40NS0xLjMyQzUuNCAxNS4zNiAyIDEyLjI4IDIgOC41IDIgNS40MiA0LjQyIDMgNy41IDNjMS43NCAwIDMuNDEuODEgNC41IDIuMDlDMTMuMDkgMy44MSAxNC43NiAzIDE2LjUgM2MxOS41OCAzIDIyIDUuNDIgMjIgOC41YzAgMy43OC0zLjQgNi44Ni04LjU1IDExLjU0TDEyIDIxLjM1eiIvPjwvc3ZnPg==" type="image/svg+xml">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iYmxhY2siPjxwYXRoIGQ9Ik0xMiAyMS4zNWwtMS40NS0xLjMyQzUuNCAxNS4zNiAyIDEyLjIyIDIgOC41IDIgNS40MiA0LjQyIDMgNy41IDNjMS43NCAwIDMuNDEuODEgNC41IDIuMDlDMTMuMDkgMy44MSAxNC43NiAzIDE2LjUgM2MxOS41OCAzIDIyIDUuNDIgMjIgOC41YzAgMy43OC0zLjQgNi44Ni04LjU1IDExLjU0TDEyIDIxLjM1eiIvPjwvc3ZnPg==">

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Noto+Serif+JP:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Firebase (Compat Mode for HTML) -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>

    <style>
        /* Base Settings */
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #F5F5F4;
            color: #44403c;
            padding-top: env(safe-area-inset-top);
            -webkit-tap-highlight-color: transparent;
            height: 100vh;
            overflow: hidden;
        }

        /* Page Transitions */
        .page {
            display: none;
            height: 100%;
            overflow-y: auto;
            padding-bottom: 140px; 
            opacity: 0;
            transition: opacity 0.2s ease-in;
        }
        .page.active {
            display: block;
            opacity: 1;
        }

        /* Utilities */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .serif-title { font-family: 'Noto Serif JP', serif; }
        
        /* Navigation Styles */
        .nav-item.active { color: #292524; }
        .nav-item.active svg { stroke-width: 2.5px; }
        
        /* Specific Card Styles */
        .driver-card { background: linear-gradient(135deg, #292524 0%, #44403c 100%); color: white; }
        .jp-card:active { transform: scale(0.98); background-color: #e5e5e5; transition: 0.1s; }
        
        /* Map & Modal Fixes */
        #zoom-modal { backdrop-filter: blur(8px); }
        .leaflet-pane { z-index: 1 !important; }
        .leaflet-control { z-index: 2 !important; }
        
        /* Splash Screen */
        #splash-screen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #fff; z-index: 9999; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            transition: opacity 0.8s; 
        }
        
        /* Status Dot */
        #connection-status { position: absolute; top: 15px; left: 15px; z-index: 50; width: 8px; height: 8px; border-radius: 50%; }
        .status-online { background-color: #22c55e; box-shadow: 0 0 5px #22c55e; }
        .status-offline { background-color: #ef4444; box-shadow: 0 0 5px #ef4444; }

        /* Custom Map Zoom Styling */
        #map-zoom-container {
            width: 100%;
            height: 320px; /* Increased height for better viewing */
            overflow: hidden;
            position: relative;
        }
        #user-map-img {
            transform-origin: 0 0;
            transition: transform 0.15s ease-out;
            cursor: grab;
            position: absolute;
            left: 0;
            top: 0;
        }
        .grabbing { cursor: grabbing !important; }
    </style>
</head>
<body class="antialiased">

    <!-- Splash Screen -->
    <div id="splash-screen">
        <div class="text-center animate-pulse px-6">
            <h1 class="text-4xl font-bold tracking-widest text-stone-800 mb-2 serif-title">OSAKA</h1>
            <h2 class="text-lg font-medium tracking-wide text-stone-500 mb-6">Family Trip 2025</h2>
            <div class="w-8 h-0.5 bg-stone-300 mx-auto mb-4"></div>
            <p class="text-xs text-stone-400 tracking-widest font-mono">2025.12.13 - 12.18</p>
        </div>
    </div>

    <!-- Connection Status Indicator (Top Left) -->
    <div id="connection-status" class="status-offline" title="é€£ç·šç‹€æ…‹"></div>

    <!-- PAGE 1: è¡Œç¨‹ (Flight/Itinerary) -->
    <div id="page-flight" class="page no-scrollbar">
        <!-- Header Image -->
        <div class="relative h-60 w-full overflow-hidden z-10 group">
            <img id="daily-scenic-img" src="" class="w-full h-full object-cover transition-opacity duration-700">
            <div class="absolute inset-0 bg-gradient-to-t from-stone-900/70 to-transparent"></div>
            <div class="absolute bottom-6 left-6 text-white">
                <div class="flex items-center gap-2 mb-2 opacity-90">
                    <span class="bg-white/20 px-2 py-0.5 rounded text-[10px] font-bold backdrop-blur-sm tracking-wider uppercase">Day <span id="header-day-num">1</span></span>
                </div>
                <h1 class="text-3xl font-bold serif-title tracking-wide">OSAKA Family Trip</h1>
            </div>
            <label class="absolute bottom-6 right-6 bg-black/30 hover:bg-black/50 text-white p-2 rounded-full cursor-pointer backdrop-blur-md transition-colors">
                <input type="file" accept="image/*" class="hidden" onchange="handleHeaderUpload(event)">
                <i data-lucide="camera" class="w-5 h-5"></i>
            </label>
        </div>

        <!-- Sticky Date Tabs -->
        <div class="sticky top-0 bg-[#F5F5F4]/95 backdrop-blur z-30 border-b border-stone-200 shadow-sm mt-[-20px] pt-6 rounded-t-3xl">
            <div class="flex items-center justify-between pl-2 pr-4 py-2">
                <div class="flex overflow-x-auto no-scrollbar space-x-2 py-1 flex-1" id="date-tabs"></div>
                <button onclick="openAddModal()" class="flex-shrink-0 ml-2 bg-stone-800 text-white px-3 py-1.5 rounded-full text-xs font-bold shadow-md active:bg-black flex items-center transition-colors">
                    <i data-lucide="plus" class="w-3.5 h-3.5 mr-1"></i> æ–°å¢
                </button>
            </div>
        </div>

        <!-- Weather Strip -->
        <div class="py-3 overflow-x-auto no-scrollbar">
            <div class="flex px-4 space-x-3 min-w-max" id="weather-strip">
                <div class="text-[10px] text-stone-400 p-2">Loading weather...</div>
            </div>
        </div>

        <!-- Itinerary List -->
        <div id="itinerary-list" class="p-4 space-y-3 pb-24 min-h-[300px]"></div>
    </div>

    <!-- PAGE 2: è³¼ç‰© (Shopping) -->
    <div id="page-shopping" class="page no-scrollbar bg-stone-50">
        <div class="sticky top-0 bg-[#F5F5F4]/95 backdrop-blur z-20 border-b border-stone-200 px-5 py-4 mt-safe-top">
            <h2 class="text-xl font-bold text-stone-800 serif-title">å¿…è²·æ¸…å–®</h2>
        </div>
        <div class="p-4">
            <!-- Add Shopping Item -->
            <div class="bg-white p-4 rounded-xl border border-stone-200 shadow-sm mb-6">
                <div class="flex gap-3 items-start">
                    <label class="w-20 h-20 bg-stone-100 rounded-lg flex flex-col items-center justify-center cursor-pointer border border-stone-200 hover:bg-stone-200 flex-shrink-0 overflow-hidden relative group">
                        <input type="file" accept="image/*" class="hidden" onchange="handleShopImg(event)">
                        <img id="shop-img-preview" class="hidden w-full h-full object-cover">
                        <div id="shop-img-placeholder" class="text-stone-400 flex flex-col items-center">
                            <i data-lucide="camera" class="w-5 h-5 mb-1"></i>
                            <span class="text-[10px]">ç…§ç‰‡</span>
                        </div>
                    </label>
                    <div class="flex-1 space-y-2">
                        <input type="text" id="shop-name" placeholder="å•†å“åç¨± (ä¾‹: EVEæ­¢ç—›è—¥)" class="w-full bg-stone-50 border-none rounded-lg px-3 py-2 text-sm outline-none font-bold">
                        <input type="text" id="shop-note" placeholder="å‚™è¨» (ä¾‹: è—è‰²åŒ…è£, 2ç›’)" class="w-full bg-stone-50 border-none rounded-lg px-3 py-2 text-xs outline-none">
                    </div>
                </div>
                <button onclick="addShopItem()" class="mt-3 w-full bg-stone-800 text-white py-2 rounded-lg text-sm font-bold flex items-center justify-center">
                    <i data-lucide="plus" class="w-4 h-4 mr-1"></i> åŠ å…¥æ¸…å–®
                </button>
            </div>
            <!-- Shopping List Grid -->
            <div id="shopping-list" class="grid grid-cols-2 gap-3 pb-20"></div>
        </div>
    </div>

    <!-- PAGE 3: è¡Œæ (Luggage) -->
    <div id="page-luggage" class="page no-scrollbar">
        <div class="sticky top-0 bg-[#F5F5F4]/95 backdrop-blur z-20 border-b border-stone-200 px-5 py-4 mt-safe-top">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold text-stone-800 serif-title">è¡Œææ¸…å–®</h2>
                <span class="text-xs font-mono bg-stone-200 px-2 py-1 rounded text-stone-600" id="luggage-count">0/0</span>
            </div>
            <div class="w-full bg-stone-200 h-1 mt-3 rounded-full overflow-hidden">
                <div id="progress-bar" class="bg-stone-800 h-full w-0 transition-all duration-500"></div>
            </div>
            <div class="mt-4 flex gap-2">
                <input type="text" id="new-luggage-item" placeholder="æ–°å¢ç‰©å“..." class="flex-1 bg-white border border-stone-200 rounded-lg px-4 py-2 text-sm outline-none focus:border-stone-400">
                <button onclick="addLuggageItem()" class="bg-stone-800 text-white px-4 rounded-lg text-sm font-bold shadow-sm">æ–°å¢</button>
            </div>
        </div>
        <div class="p-5 space-y-2" id="luggage-list"></div>
    </div>

    <!-- PAGE 4: è¨˜å¸³ (Money) -->
    <div id="page-money" class="page no-scrollbar">
        <div class="sticky top-0 bg-[#F5F5F4]/95 backdrop-blur z-20 border-b border-stone-200 px-5 py-4 mt-safe-top">
             <h2 class="text-xl font-bold text-stone-800 serif-title">æ›åŒ¯ & è¨˜å¸³</h2>
        </div>
        <div class="p-5">
            <!-- Calculator -->
            <div class="bg-stone-800 text-white rounded-2xl p-6 shadow-xl mb-6 relative overflow-hidden">
                <div class="flex justify-between items-center mb-6 relative z-10">
                     <span class="text-[10px] font-bold tracking-[0.2em] text-stone-400">EXCHANGE</span>
                     <div class="text-[10px] bg-stone-700 px-2 py-1 rounded text-stone-300">Rate: 0.215</div>
                </div>
                <div class="flex items-end mb-4 border-b border-stone-600 pb-2 relative z-10">
                    <span class="text-lg mr-3 font-light text-stone-400">JPY</span>
                    <input type="number" id="jpy-input" placeholder="0" class="w-full bg-transparent text-4xl font-mono outline-none text-white placeholder-stone-600 text-right" oninput="calculateExchange()">
                </div>
                <div class="flex items-end justify-between pt-2 relative z-10">
                    <span class="text-lg font-light text-stone-400">TWD</span>
                    <span class="text-4xl font-mono font-bold text-emerald-400" id="twd-output">0</span>
                </div>
            </div>

            <!-- Expense Chart -->
            <div class="mb-6 bg-white p-4 rounded-xl border border-stone-200 shadow-sm">
                <div class="text-xs font-bold text-stone-400 uppercase mb-2">æ”¯å‡ºæ¯”ä¾‹</div>
                <div class="flex h-4 rounded-full overflow-hidden w-full bg-stone-100" id="expense-chart">
                    <!-- Bars injected by JS -->
                </div>
                <div class="flex justify-between mt-2 text-[10px] text-stone-500 font-mono" id="expense-legend">
                    <!-- Legend injected by JS -->
                </div>
            </div>

            <!-- Input -->
            <div class="bg-white p-4 rounded-xl border border-stone-200 shadow-sm mb-6">
                 <div class="flex gap-2 mb-2">
                     <input type="text" id="expense-note" placeholder="é …ç›®" class="flex-grow bg-stone-50 border-none rounded-lg px-3 py-2.5 text-sm outline-none">
                     <select id="expense-cat" class="bg-stone-50 border-none rounded-lg px-2 py-2.5 text-xs outline-none text-stone-600 font-bold w-20">
                         <option value="food">é£²é£Ÿ</option>
                         <option value="shop">è³¼ç‰©</option>
                         <option value="trans">äº¤é€š</option>
                         <option value="other">å…¶ä»–</option>
                     </select>
                 </div>
                 <div class="flex gap-2">
                    <input type="number" id="expense-amt" placeholder="æ—¥å¹£é‡‘é¡" class="flex-grow bg-stone-50 border-none rounded-lg px-3 py-2.5 text-sm outline-none">
                    <button onclick="addExpense()" class="bg-stone-800 text-white px-6 rounded-lg text-sm font-bold hover:bg-stone-700">æ–°å¢</button>
                 </div>
            </div>
            <!-- List -->
            <div class="flex justify-between items-end mb-3 px-1">
                <h3 class="text-sm font-bold text-stone-600">æ”¯å‡ºæ˜ç´°</h3>
                <div class="text-right cursor-pointer" onclick="toggleTotalCurrency()">
                    <div class="text-[10px] text-stone-400 uppercase">Total Spent</div>
                    <div class="font-mono font-bold text-lg text-stone-800" id="total-expense">Â¥0</div>
                </div>
            </div>
            <div id="expense-list" class="space-y-3 pb-20"></div>
        </div>
    </div>

    <!-- PAGE 5: è³‡è¨Š (Info) -->
    <div id="page-info" class="page no-scrollbar bg-stone-50">
        <div class="sticky top-0 bg-[#F5F5F4]/95 backdrop-blur z-20 border-b border-stone-200 px-5 py-4 mt-safe-top">
            <h2 class="text-xl font-bold text-stone-800 serif-title">æ—…ç¨‹è³‡è¨Šå¡</h2>
        </div>
        <div class="p-5 space-y-6">
            <!-- Finger Cards -->
            <div class="grid grid-cols-2 gap-3">
                <div onclick="openZoomCard('çµå¸³', 'ãŠä¼šè¨ˆã‚’ãŠé¡˜ã„ã—ã¾ã™', 'O-kai-kei o o-ne-gai shi-masu')" class="bg-white p-4 rounded-xl border border-stone-200 jp-card cursor-pointer shadow-sm"><div class="text-xs text-stone-400 mb-1">éº»ç…©è«‹çµå¸³</div><div class="font-bold text-stone-800 text-lg serif-title">ãŠä¼šè¨ˆ...</div></div>
                <div onclick="openZoomCard('æ´—æ‰‹é–“', 'ãŠæ‰‹æ´—ã„ã¯ã©ã“ã§ã™ã‹ï¼Ÿ', 'O-te-a-rai wa do-ko de-su-ka')" class="bg-white p-4 rounded-xl border border-stone-200 jp-card cursor-pointer shadow-sm"><div class="text-xs text-stone-400 mb-1">è«‹å•å»æ‰€åœ¨å“ª</div><div class="font-bold text-stone-800 text-lg serif-title">ãŠæ‰‹æ´—ã„ã¯...</div></div>
                <div onclick="openZoomCard('å¤–å¸¶', 'æŒã¡å¸°ã‚Šã§ãŠé¡˜ã„ã—ã¾ã™', 'Mo-chi-ka-e-ri de o-ne-gai shi-ma-su')" class="bg-white p-4 rounded-xl border border-stone-200 jp-card cursor-pointer shadow-sm"><div class="text-xs text-stone-400 mb-1">æˆ‘è¦å¤–å¸¶</div><div class="font-bold text-stone-800 text-lg serif-title">æŒã¡å¸°ã‚Šã§...</div></div>
                <div onclick="openZoomCard('å¡‘è† è¢‹', 'è¢‹ã‚’ãã ã•ã„', 'Fu-ku-ro o ku-da-sai')" class="bg-white p-4 rounded-xl border border-stone-200 jp-card cursor-pointer shadow-sm"><div class="text-xs text-stone-400 mb-1">è«‹çµ¦æˆ‘è¢‹å­</div><div class="font-bold text-stone-800 text-lg serif-title">è¢‹ã‚’...</div></div>
                <div onclick="openZoomCard('æ°´', 'ãŠæ°´ã‚’ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ', 'O-mi-zu o i-ta-da-ke-ma-su-ka')" class="bg-white p-4 rounded-xl border border-stone-200 jp-card cursor-pointer shadow-sm"><div class="text-xs text-stone-400 mb-1">è«‹çµ¦æˆ‘æ°´</div><div class="font-bold text-stone-800 text-lg serif-title">ãŠæ°´ã‚’...</div></div>
                <div onclick="openZoomCard('å»å†°', 'æ°·ãªã—ã§ãŠé¡˜ã„ã—ã¾ã™', 'Ko-ori na-shi de o-ne-gai shi-ma-su')" class="bg-white p-4 rounded-xl border border-stone-200 jp-card cursor-pointer shadow-sm"><div class="text-xs text-stone-400 mb-1">å»å†° (çµ¦å°å­©)</div><div class="font-bold text-stone-800 text-lg serif-title">æ°·ãªã—ã§...</div></div>
                <div onclick="openZoomCard('ç„¡é…’ç²¾è«‹æ±‚', 'å­ä¾›ãŒé£Ÿã¹ã‚‹ã®ã§ã€<br>ãŠé…’ãŒå…¥ã£ã¦ã„ãªã„æ–™ç†ã‚’<br>ãŠé¡˜ã„ã§ãã¾ã™ã‹ï¼Ÿ', 'No Alcohol for kids')" class="col-span-2 bg-orange-50 p-4 rounded-xl border border-orange-100 jp-card cursor-pointer shadow-sm flex items-center justify-between"><div><div class="text-xs text-orange-400 mb-1 font-bold">çµ¦å°å­©åƒçš„ (ç„¡é…’ç²¾)</div><div class="font-bold text-stone-800 text-lg serif-title">ãŠé…’ãŒå…¥ã£ã¦ã„ãªã„...</div></div><i data-lucide="ban" class="w-6 h-6 text-orange-300"></i></div>
            </div>
            
            <!-- Map -->
            <div class="bg-white rounded-xl overflow-hidden shadow-sm border border-stone-200">
                <div class="p-3 border-b border-stone-100 bg-stone-50 flex justify-between items-center">
                    <h3 class="text-xs font-bold text-stone-600 uppercase tracking-wider flex items-center"><i data-lucide="map" class="w-4 h-4 mr-2"></i> Subway Map</h3>
                    <div class="flex gap-2 items-center">
                        <button onclick="zoomMap(1.2)" class="text-stone-500 hover:text-stone-800 p-1 rounded-full hover:bg-stone-200 transition-colors" title="æ”¾å¤§"><i data-lucide="zoom-in" class="w-4 h-4"></i></button>
                        <button onclick="zoomMap(1/1.2)" class="text-stone-500 hover:text-stone-800 p-1 rounded-full hover:bg-stone-200 transition-colors" title="ç¸®å°"><i data-lucide="zoom-out" class="w-4 h-4"></i></button>
                        <button onclick="zoomMap(0, true)" class="text-stone-500 hover:text-stone-800 p-1 rounded-full hover:bg-stone-200 transition-colors" title="é‡è¨­"><i data-lucide="maximize" class="w-4 h-4"></i></button>
                        <label class="cursor-pointer bg-white border border-stone-200 px-2 py-1 rounded text-[10px] font-bold text-stone-500 hover:bg-stone-100 transition-colors">æ›´æ›åœ–ç‰‡
                            <input type="file" id="map-upload" accept="image/*" class="hidden" onchange="handleMapUpload(event)">
                        </label>
                    </div>
                </div>
                <div class="overflow-hidden bg-stone-100 relative">
                    <div id="map-zoom-container" class="cursor-grab" onmousedown="startDrag(event)" onmousemove="dragMap(event)" onmouseup="stopDrag()" onmouseleave="stopDrag()" ontouchstart="startDrag(event)" ontouchmove="dragMap(event)" ontouchend="stopDrag()">
                        <img id="user-map-img" src="https://upload.wikimedia.org/wikipedia/commons/thumb/4/41/Osaka_Metro_Route_Map_%28En%29.svg/1920px-Osaka_Metro_Route_Map_%28En%29.svg.png" class="w-full object-contain min-h-[200px] transition-transform duration-150 ease-out" style="transform: scale(1) translate(0px, 0px);">
                    </div>
                </div>
            </div>

            <!-- Hotel -->
            <div class="driver-card rounded-xl p-6 shadow-xl relative overflow-hidden group">
                <div class="relative z-10">
                    <div class="flex items-center justify-between mb-4">
                        <span class="bg-white/20 px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider text-white">Taxi Card</span>
                        <button onclick="copyAddress('ã€’541-0041 å¤§é˜ªåºœå¤§é˜ªå¸‚ä¸­å¤®åŒºåŒ—æµœ 2-4-11')" class="bg-white/20 hover:bg-white/40 p-1.5 rounded text-white transition-colors"><i data-lucide="copy" class="w-4 h-4"></i></button>
                    </div>
                    <h3 class="text-sm text-stone-300 mb-1">ä½ å¥½ï¼Œè«‹è¼‰æˆ‘å»é€™å®¶é£¯åº—</h3>
                    <p class="text-xl font-bold serif-title mb-6 leading-relaxed">é‹è»¢æ‰‹ã•ã‚“ã€<br>ã“ã®ãƒ›ãƒ†ãƒ«ã¾ã§ãŠé¡˜ã„ã—ã¾ã™ã€‚</p>
                    <div class="bg-white/10 p-4 rounded-lg backdrop-blur-sm border border-white/10">
                        <h4 class="font-bold text-lg text-white mb-1">Ostay Vermillion Kitahama</h4>
                        <p class="text-sm text-stone-300 serif-title leading-relaxed">ã€’541-0041 å¤§é˜ªåºœå¤§é˜ªå¸‚ä¸­å¤®åŒºåŒ—æµœ 2-4-11</p>
                    </div>
                    <div class="mt-4 flex gap-3"><a href="https://goo.gl/maps/JuA5v7KaqMzoPAxD6" target="_blank" class="flex-1 bg-white text-stone-900 py-2.5 rounded-lg text-xs font-bold text-center flex items-center justify-center hover:bg-stone-200 transition-colors"><i data-lucide="map-pin" class="w-3 h-3 mr-1.5"></i> Google Maps</a></div>
                </div>
            </div>

            <!-- Notes -->
            <div class="bg-white rounded-xl border border-stone-200 p-4 shadow-sm">
                 <h3 class="text-sm font-bold text-stone-800 mb-3 flex items-center"><i data-lucide="sticky-note" class="w-4 h-4 mr-2"></i> æˆ‘çš„å‚™å¿˜éŒ„</h3>
                 <div class="flex gap-2 mb-3"><input type="text" id="new-note-input" placeholder="ä¾‹ï¼šWifiå¯†ç¢¼..." class="flex-1 bg-stone-50 border border-stone-200 rounded-lg px-3 py-2 text-sm outline-none font-sans"><button onclick="addInfoNote()" class="bg-stone-800 text-white px-3 rounded-lg text-xs font-bold">æ–°å¢</button></div>
                 <div id="info-notes-list" class="space-y-2 font-sans"></div>
            </div>

            <!-- Emergency -->
            <div class="pb-2">
                <h3 class="text-xs font-bold text-stone-400 uppercase tracking-wider mb-3 ml-1">ç·Šæ€¥å”åŠ©</h3>
                <div class="grid grid-cols-1 gap-3"><a href="tel:+81662278623" class="flex items-center p-4 bg-white border border-stone-200 rounded-xl shadow-sm active:bg-stone-50"><div class="bg-blue-100 p-2.5 rounded-full mr-4"><i data-lucide="building-2" class="w-5 h-5 text-blue-700"></i></div><div><div class="font-bold text-sm text-stone-800">å°åŒ—é§å¤§é˜ªç¶“æ¿Ÿæ–‡åŒ–è¾¦äº‹è™•</div><div class="text-xs text-stone-500">+81-6-6227-8623</div></div></a></div>
                <div class="grid grid-cols-2 gap-3 mt-3"><a href="tel:110" class="flex items-center p-3 bg-white border border-red-100 rounded-xl shadow-sm active:bg-red-50"><div class="bg-red-100 p-2 rounded-full mr-3"><i data-lucide="phone" class="w-4 h-4 text-red-600"></i></div><span class="font-bold text-sm text-stone-800">å ±è­¦ 110</span></a><a href="tel:119" class="flex items-center p-3 bg-white border border-green-100 rounded-xl shadow-sm active:bg-green-50"><div class="bg-green-100 p-2 rounded-full mr-3"><i data-lucide="ambulance" class="w-4 h-4 text-green-600"></i></div><span class="font-bold text-sm text-stone-800">æ€¥æ•‘ 119</span></a></div>
            </div>

            <!-- Account & Sync Section (Visual Fixes Applied Here) -->
            <div class="bg-white rounded-xl border border-stone-200 p-4 shadow-sm mb-8">
                 <h3 class="text-sm font-bold text-stone-800 mb-3 flex items-center"><i data-lucide="cloud" class="w-4 h-4 mr-2"></i> è³‡æ–™åŒæ­¥èˆ‡å‚™ä»½</h3>
                 <div class="flex flex-col gap-2">
                     <div id="user-info" class="text-xs text-stone-500 mb-2">ç›®å‰ç‹€æ…‹: <span id="auth-status">æœªç™»å…¥ (æœ¬æ©Ÿæ¨¡å¼)</span></div>
                     <button onclick="loginWithGoogle()" class="w-full py-2 bg-white border border-stone-300 rounded-lg text-xs font-bold text-stone-700 flex items-center justify-center hover:bg-stone-50">
                         <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-4 h-4 mr-2"> Google ç™»å…¥åŒæ­¥
                     </button>
                     <div class="flex gap-2 mt-1">
                         <button onclick="exportData()" class="flex-1 py-2 bg-stone-100 rounded-lg text-xs font-bold text-stone-600 hover:bg-stone-200 flex items-center justify-center">
                             <i data-lucide="download" class="w-3 h-3 mr-1"></i> åŒ¯å‡ºå‚™ä»½
                         </button>
                         <label class="flex-1 py-2 bg-stone-100 rounded-lg text-xs font-bold text-stone-600 hover:bg-stone-200 flex items-center justify-center cursor-pointer">
                             <input type="file" accept=".json" class="hidden" onchange="importData(event)">
                             <i data-lucide="upload" class="w-3 h-3 mr-1"></i> åŒ¯å…¥é‚„åŸ
                         </label>
                     </div>
                     <div class="w-full h-px bg-red-100 mt-4 mb-2"></div> <!-- New separator for emphasis -->
                     <button onclick="resetItineraryData()" class="w-full py-3 bg-red-100 border border-red-300 rounded-lg text-sm font-bold text-red-700 flex items-center justify-center hover:bg-red-200">
                         <i data-lucide="alert-triangle" class="w-4 h-4 mr-1"></i> é‡è¨­æ‰€æœ‰è¡Œç¨‹è³‡æ–™
                     </button>
                 </div>
            </div>
        </div>
    </div>

    <!-- FIXED BOTTOM NAVIGATION (Z-INDEX 100 FIXED) -->
    <nav class="fixed bottom-0 left-0 right-0 w-full bg-[#F5F5F4]/95 backdrop-blur border-t border-stone-200 pb-safe z-[100] rounded-t-xl shadow-[0_-5px_20px_rgba(0,0,0,0.02)] h-20">
        <div class="flex justify-around items-center h-full pb-2">
            <button onclick="switchPage('flight')" class="nav-item active flex flex-col items-center justify-center w-full text-stone-300 transition-colors" id="nav-flight">
                <i data-lucide="calendar-days" class="w-5 h-5 mb-0.5"></i>
                <span class="text-[9px] font-medium">è¡Œç¨‹</span>
            </button>
            <button onclick="switchPage('shopping')" class="nav-item flex flex-col items-center justify-center w-full text-stone-300 transition-colors" id="nav-shopping">
                <i data-lucide="shopping-bag" class="w-5 h-5 mb-0.5"></i>
                <span class="text-[9px] font-medium">è³¼ç‰©</span>
            </button>
            <button onclick="switchPage('luggage')" class="nav-item flex flex-col items-center justify-center w-full text-stone-300 transition-colors" id="nav-luggage">
                <i data-lucide="briefcase" class="w-5 h-5 mb-0.5"></i>
                <span class="text-[9px] font-medium">è¡Œæ</span>
            </button>
            <button onclick="switchPage('money')" class="nav-item flex flex-col items-center justify-center w-full text-stone-300 transition-colors" id="nav-money">
                <i data-lucide="wallet" class="w-5 h-5 mb-0.5"></i>
                <span class="text-[9px] font-medium">è¨˜å¸³</span>
            </button>
            <button onclick="switchPage('info')" class="nav-item flex flex-col items-center justify-center w-full text-stone-300 transition-colors" id="nav-info">
                <i data-lucide="info" class="w-5 h-5 mb-0.5"></i>
                <span class="text-[9px] font-medium">è³‡è¨Š</span>
            </button>
        </div>
    </nav>

    <!-- Modals -->
    <div id="zoom-modal" class="fixed inset-0 bg-black/90 z-[200] hidden flex flex-col justify-center items-center p-6 animate-fade-in" onclick="closeZoomCard()"><div class="text-white text-center w-full max-w-lg" onclick="event.stopPropagation()"><h3 id="zoom-title" class="text-stone-400 text-sm font-bold uppercase tracking-widest mb-6">TITLE</h3><div id="zoom-jp" class="text-4xl sm:text-5xl font-bold serif-title leading-snug mb-6 text-white"></div><div id="zoom-ro" class="text-stone-400 font-mono text-sm mb-12"></div><button onclick="closeZoomCard()" class="px-8 py-3 rounded-full border border-white/30 text-white text-sm hover:bg-white/10 transition-colors">é—œé–‰ (Close)</button></div></div>
    
    <div id="add-modal" class="fixed inset-0 bg-stone-900/60 z-[100] hidden flex items-end sm:items-center justify-center sm:p-4 backdrop-blur-sm">
        <div class="bg-white rounded-t-2xl sm:rounded-2xl w-full max-w-sm p-6 shadow-2xl animate-slide-up max-h-[90vh] overflow-y-auto no-scrollbar">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-stone-800" id="modal-title">æ–°å¢è¡Œç¨‹</h3>
                <button onclick="closeAddModal()" class="p-2 bg-stone-100 rounded-full hover:bg-stone-200"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            <input type="hidden" id="edit-id" value="">
            <input type="hidden" id="new-lat" value="">
            <input type="hidden" id="new-lng" value="">

            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-bold text-stone-400 uppercase block mb-1">æ¨™é¡Œ</label>
                    <input type="text" id="new-title" class="w-full border-b border-stone-200 py-2 outline-none bg-transparent text-lg font-sans">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-stone-400 uppercase block mb-1">åœ°é»è³‡è¨Š</label>
                    <div class="flex items-center">
                        <input type="text" id="new-location" placeholder="è¼¸å…¥åç¨± (å¦‚: å¿ƒé½‹æ©‹)" class="w-full border-b border-stone-200 py-2 outline-none bg-transparent text-sm font-sans" oninput="updateGoogleMapsLink()">
                    </div>
                    
                    <!-- New Google Maps Search Link -->
                    <a id="google-maps-link" target="_blank" class="text-[10px] text-blue-600 hover:text-blue-800 underline mt-1 flex items-center hidden" href="#">
                        <i data-lucide="external-link" class="w-3 h-3 mr-1"></i> (æ¨è–¦) é»æ­¤å‰å¾€ Google Maps æœå°‹ç²¾ç¢ºä½ç½®
                    </a>

                    <p class="text-[10px] text-red-500 mt-1 flex items-center" id="map-search-feedback">
                        <i data-lucide="map-pin" class="w-3 h-3 mr-1"></i>
                        è«‹å…ˆé»æ“Šä¸Šæ–¹ **Google Maps é€£çµ** æŸ¥è©¢åæ¨™ï¼Œå†é»æ“Šä¸‹æ–¹çš„åœ°åœ–æ¨™è¨˜ã€‚
                    </p>
                    <!-- Map Picker -->
                    <div class="relative w-full h-40 bg-stone-100 rounded-lg overflow-hidden border border-stone-200 group mt-2">
                         <div id="picker-map" class="w-full h-full z-0"></div>
                         <div class="absolute top-2 right-2 z-10 bg-white px-2 py-1 rounded shadow text-[10px] font-bold text-stone-500 opacity-80">é»æ“Šåœ°åœ–è¨­å®šä½ç½®</div>
                    </div>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-stone-400 uppercase block mb-1">å‚™è¨» / ç­†è¨˜</label>
                    <textarea id="new-note" rows="3" placeholder="ä¾‹å¦‚ï¼šé ç´„è™Ÿç¢¼ #1234ã€å¿…é»èƒèŸ¹..." class="w-full bg-stone-50 border border-stone-200 rounded-lg p-3 text-sm outline-none resize-none"></textarea>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] font-bold text-stone-400 uppercase block mb-1">æ™‚é–“</label>
                        <input type="time" id="new-time" class="w-full border-b border-stone-200 py-2 outline-none bg-transparent font-mono">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-stone-400 uppercase block mb-1">æ—¥æœŸ</label>
                        <select id="new-day" class="w-full border-b border-stone-200 py-2 outline-none bg-transparent"></select>
                    </div>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-stone-400 uppercase block mb-2">åˆ†é¡</label>
                    <div class="grid grid-cols-4 gap-2">
                        <!-- 
                           ä¿®æ”¹ç‚ºæ¥µç°¡æŸ”å’Œé¢¨æ ¼ (Corrected colors to match list)
                           ç¾é£Ÿ (Latte): bg-[#F5F0EB], border-[#C7B299], text-[#8C7B70]
                           æ™¯é» (Warm Gray): bg-[#F5F5F4], border-[#A8A29E], text-[#57534E]
                           è³¼ç‰© (Haze Blue): bg-[#F1F5F9], border-[#94A3B8], text-[#475569]
                           é£›è¡Œ (Dried Rose): bg-[#FEF2F2], border-[#ECA9A9], text-[#991B1B]
                        -->
                        <label class="cursor-pointer">
                            <input type="radio" name="new-type" value="food" class="peer hidden" checked>
                            <div class="flex flex-col items-center justify-center p-2 bg-white rounded-lg border border-stone-200 peer-checked:bg-[#F5F0EB] peer-checked:border-[#C7B299] peer-checked:text-[#8C7B70] transition-colors">
                                <i data-lucide="utensils" class="w-4 h-4"></i><span class="text-[10px] mt-1 font-bold">ç¾é£Ÿ</span>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="new-type" value="spot" class="peer hidden">
                            <div class="flex flex-col items-center justify-center p-2 bg-white rounded-lg border border-stone-200 peer-checked:bg-[#F5F5F4] peer-checked:border-[#A8A29E] peer-checked:text-[#57534E] transition-colors">
                                <i data-lucide="map-pin" class="w-4 h-4"></i><span class="text-[10px] mt-1 font-bold">æ™¯é»</span>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="new-type" value="shop" class="peer hidden">
                            <div class="flex flex-col items-center justify-center p-2 bg-white rounded-lg border border-stone-200 peer-checked:bg-[#F1F5F9] peer-checked:border-[#94A3B8] peer-checked:text-[#475569] transition-colors">
                                <i data-lucide="shopping-bag" class="w-4 h-4"></i><span class="text-[10px] mt-1 font-bold">è³¼ç‰©</span>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="new-type" value="flight" class="peer hidden">
                            <div class="flex flex-col items-center justify-center p-2 bg-white rounded-lg border border-stone-200 peer-checked:bg-[#FEF2F2] peer-checked:border-[#ECA9A9] peer-checked:text-[#991B1B] transition-colors">
                                <i data-lucide="plane" class="w-4 h-4"></i><span class="text-[10px] mt-1 font-bold">é£›è¡Œ</span>
                            </div>
                        </label>
                    </div>
                </div>
            </div>
            <button onclick="saveItineraryItem()" class="mt-8 w-full py-3.5 rounded-xl bg-stone-800 text-white font-bold shadow-lg hover:bg-black active:scale-[0.98] transition-all flex items-center justify-center">
                <i data-lucide="check" class="w-4 h-4 mr-2"></i> <span id="modal-btn-text">ç¢ºèªæ–°å¢</span>
            </button>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBGmvolsS8AgPfm09qynSVIz5GOcvXDKCM",
            authDomain: "osaka-family-trip.firebaseapp.com",
            databaseURL: "https://osaka-family-trip-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "osaka-family-trip",
            storageBucket: "osaka-family-trip.firebasestorage.app",
            messagingSenderId: "303743481222",
            appId: "1:303743481222:web:e3e4ecb51ff89a3acfe807"
        };
        const appId = 'osaka-2025-v4-map';
        let db = null, auth = null;

        const TRIP_START = new Date('2025-12-13T00:00:00');
        const TOTAL_DAYS = 6;
        const WEEKDAYS = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const SCENIC_IMAGES = ["https://images.unsplash.com/photo-1542051841857-5f90071e7989?q=80&w=1200", "https://images.unsplash.com/photo-1505337833003-88220268523c?q=80&w=1200", "https://images.unsplash.com/photo-1478436127897-769e1b3f0f36?q=80&w=1200", "https://images.unsplash.com/photo-1476514525535-07fb3b4ae5f1?q=80&w=1200", "https://images.unsplash.com/photo-1572975765715-288219662e08?q=80&w=1200", "https://images.unsplash.com/photo-1605626993138-03822295696d?q=80&w=1200"];
        // Initial Dummy Data (Will be overwritten by API)
        let weatherData = [{icon:'â›…',temp:'--'},{icon:'â˜€ï¸',temp:'--'},{icon:'â˜€ï¸',temp:'--'},{icon:'â˜ï¸',temp:'--'},{icon:'ğŸŒ§ï¸',temp:'--'},{icon:'â›…',temp:'--'}];
        
        let currentDayIndex = 0;
        let mapInstance = null;
        let pickerMap = null, pickerMarker = null;
        let userHeaderImage = localStorage.getItem('osaka_header_img');
        let userMapImage = localStorage.getItem('osaka_map_img') || "https://upload.wikimedia.org/wikipedia/commons/thumb/4/41/Osaka_Metro_Route_Map_%28En%29.svg/1920px-Osaka_Metro_Route_Map_%28En%29.svg.png"; // Default map image
        let itineraryData = [], luggageData = [], expenses = [], infoNotes = [], shoppingData = [];
        let currentUser = null;
        let tempShopImg = null;
        
        // Map Zoom/Pan State
        let mapZoomLevel = 1.0;
        let mapPanX = 0;
        let mapPanY = 0;
        let isDragging = false;
        let startX = 0;
        let startY = 0;
        let currentPanX = 0;
        let currentPanY = 0;


        // DEFAULT DATA - ONLY FLIGHTS KEPT HERE AS REQUESTED
        const DEFAULT_ITINERARY = [
            // Day 1: Arrival (Index 0) - Only flights
            { id: 'd1_1', day: 0, time: '15:25', title: 'KHH é«˜é›„èµ·é£› (CI 176)', type: 'flight', location: 'é«˜é›„å°æ¸¯æ©Ÿå ´', lat: 22.57, lng: 120.35, note: 'èˆªå»ˆ 2, é è¨ˆ13:25å ±åˆ°' },
            { id: 'd1_2', day: 0, time: '19:10', title: 'æŠµé”é—œè¥¿æ©Ÿå ´ (KIX)', type: 'flight', location: 'é—œè¥¿åœ‹éš›æ©Ÿå ´', lat: 34.434, lng: 135.235, note: 'é è¨ˆ 19:40 é–‹å§‹å…¥å¢ƒå¯©æŸ¥' },
            
            // Day 6: Departure (Index 5) - Only flights
            { id: 'd6_2', day: 5, time: '20:10', title: 'KIX é—œè¥¿æ©Ÿå ´èµ·é£› (CI 177)', type: 'flight', location: 'é—œè¥¿åœ‹éš›æ©Ÿå ´', lat: 34.434, lng: 135.235, note: 'ææ—© 2 å°æ™‚å ±åˆ°' },
            { id: 'd6_3', day: 5, time: '22:45', title: 'æŠµé”é«˜é›„ (KHH)', type: 'flight', location: 'é«˜é›„å°æ¸¯æ©Ÿå ´', lat: 22.57, lng: 120.35, note: 'çµæŸæ„‰å¿«çš„æ—…ç¨‹!' }
        ];

        // INIT
        document.addEventListener('DOMContentLoaded', async () => {
            // 1. UI Inits (Safe)
            try {
                initDateTabs(); 
                initWeather(); 
                initItineraryLocal(); 
                initLuggageLocal(); 
                initExpensesLocal(); 
                initInfoNotesLocal(); 
                initShoppingLocal();
                initMapZoom(); // Initialize map zoom state
                document.getElementById('user-map-img').src = userMapImage; // Set initial map source
            } catch (e) { console.error("UI Init Err", e); }

            // 2. Async Data Fetches (Don't block)
            fetchWeather(); 

            // 3. Icons & Map (External Libs might fail)
            setTimeout(() => {
                try { lucide.createIcons(); } catch(e) { console.warn("Lucide err", e); }
            }, 500);
            
            setTimeout(() => {
                try {
                    // Initialize Map Picker on modal opening
                } catch(e) { console.warn("Map err", e); }
            }, 1000);

            // 4. Firebase (Critical but prone to errors)
            try {
                if (typeof firebase !== 'undefined') {
                    firebase.initializeApp(firebaseConfig); 
                    db = firebase.firestore(); 
                    auth = firebase.auth();
                    auth.onAuthStateChanged(user => {
                        currentUser = user;
                        if(user) {
                            document.getElementById('auth-status').innerText = `å·²ç™»å…¥: ${user.isAnonymous ? 'è¨ªå®¢' : user.displayName || user.email}`;
                            document.getElementById('auth-status').classList.add('text-green-600');
                            setupSyncListeners();
                            updateStatus(true);
                        } else {
                            auth.signInAnonymously().catch(e => console.error("Auth Err:", e));
                        }
                    });
                } else {
                    console.error("Firebase SDK not loaded");
                    updateStatus(false);
                }
            } catch(e) { console.error("Firebase Init Err:", e); updateStatus(false); }

            // 5. REMOVE SPLASH SCREEN (Guaranteed)
            setTimeout(() => { 
                const splash = document.getElementById('splash-screen');
                if(splash) {
                    splash.style.opacity = '0'; 
                    setTimeout(() => { 
                        splash.style.display = 'none'; 
                        document.getElementById('page-flight').classList.add('active'); 
                        renderItineraryList(); 
                        try { lucide.createIcons(); } catch(e){} 
                    }, 800); 
                }
            }, 2000);
        });

        // Helper to Compress Image
        function compressImage(base64Str, maxWidth = 800, quality = 0.7) {
            return new Promise((resolve) => {
                const img = new Image();
                img.src = base64Str;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > maxWidth) {
                        height = Math.round(height * (maxWidth / width));
                        width = maxWidth;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.onerror = () => resolve(base64Str); // Fail safe
            });
        }

        // --- MAP ZOOM/PAN LOGIC (New Feature) ---
        function initMapZoom() {
            const img = document.getElementById('user-map-img');
            img.style.transform = `scale(1) translate(0px, 0px)`;
            mapZoomLevel = 1.0;
            mapPanX = 0;
            mapPanY = 0;
            applyMapTransform();
        }

        function applyMapTransform() {
            const img = document.getElementById('user-map-img');
            img.style.transform = `scale(${mapZoomLevel}) translate(${mapPanX}px, ${mapPanY}px)`;
            // Update cursor based on zoom level
            const container = document.getElementById('map-zoom-container');
            container.classList.toggle('cursor-grab', mapZoomLevel > 1.0);
            container.classList.toggle('cursor-default', mapZoomLevel <= 1.0);
        }

        function zoomMap(factor, reset = false) {
            if (reset) {
                mapZoomLevel = 1.0;
                mapPanX = 0;
                mapPanY = 0;
            } else {
                mapZoomLevel = Math.min(Math.max(mapZoomLevel * factor, 1.0), 5.0); // Min 1x, Max 5x
            }
            // Recalculate pan boundaries after zoom
            const img = document.getElementById('user-map-img');
            const container = document.getElementById('map-zoom-container');
            const imgWidth = img.clientWidth * mapZoomLevel;
            const containerWidth = container.clientWidth;
            const imgHeight = img.clientHeight * mapZoomLevel;
            const containerHeight = container.clientHeight;

            if (imgWidth <= containerWidth) mapPanX = 0;
            if (imgHeight <= containerHeight) mapPanY = 0;
            
            applyMapTransform();
        }

        function startDrag(e) {
            if (mapZoomLevel <= 1.0) return;
            e.preventDefault();
            isDragging = true;
            document.getElementById('map-zoom-container').classList.add('grabbing');
            // Get touch or mouse coordinates
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            startX = clientX;
            startY = clientY;
            currentPanX = mapPanX;
            currentPanY = mapPanY;
        }

        function dragMap(e) {
            if (!isDragging || mapZoomLevel <= 1.0) return;
            e.preventDefault();
            
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            const dx = clientX - startX;
            const dy = clientY - startY;

            let newPanX = currentPanX + dx / mapZoomLevel; // Adjust pan sensitivity
            let newPanY = currentPanY + dy / mapZoomLevel;

            // Apply Boundary Checks (Prevent panning off the image)
            const img = document.getElementById('user-map-img');
            const container = document.getElementById('map-zoom-container');
            const imgWidth = img.clientWidth * mapZoomLevel;
            const imgHeight = img.clientHeight * mapZoomLevel;
            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;
            
            // Pan limits in 'un-scaled' pixels
            const limitX = (imgWidth - containerWidth) / mapZoomLevel;
            const limitY = (imgHeight - containerHeight) / mapZoomLevel;

            if (imgWidth > containerWidth) {
                mapPanX = Math.min(newPanX, 0); 
                mapPanX = Math.max(mapPanX, -limitX); 
            } else {
                mapPanX = 0;
            }
            
            if (imgHeight > containerHeight) {
                mapPanY = Math.min(newPanY, 0);
                mapPanY = Math.max(mapPanY, -limitY);
            } else {
                mapPanY = 0;
            }


            applyMapTransform();
        }

        function stopDrag() {
            if (isDragging) {
                isDragging = false;
                document.getElementById('map-zoom-container').classList.remove('grabbing');
                // Persist the current state for next drag/zoom
                currentPanX = mapPanX;
                currentPanY = mapPanY;
            }
        }


        // --- AUTH & DATA MANAGEMENT ---
        async function loginWithGoogle() {
            if(!auth) return alert("Firebase æœªåˆå§‹åŒ–");
            const provider = new firebase.auth.GoogleAuthProvider();
            try { await auth.signInWithPopup(provider); } catch(error) { alert("ç™»å…¥å¤±æ•—: " + error.message + "\n\næç¤º: è‹¥åœ¨ App å…§åµŒç€è¦½å™¨ä¸­ï¼ŒGoogle ç™»å…¥å¸¸æœƒè¢«å°é–ã€‚è«‹ä½¿ç”¨ã€ŒåŒ¯å‡ºå‚™ä»½ã€åŠŸèƒ½ã€‚"); }
        }

        function exportData() {
            const data = { itinerary: itineraryData, luggage: luggageData, expenses: expenses, notes: infoNotes, shopping: shoppingData, exportedAt: Date.now() };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `osaka_trip_backup_${new Date().toISOString().slice(0,10)}.json`; a.click();
        }

        function importData(event) {
            const file = event.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if(data.itinerary) { itineraryData = data.itinerary; localStorage.setItem('osaka_itinerary_2025_v5', JSON.stringify(itineraryData)); }
                    if(data.luggage) { luggageData = data.luggage; localStorage.setItem('osaka_luggage_2025_v2', JSON.stringify(luggageData)); }
                    if(data.expenses) { expenses = data.expenses; localStorage.setItem('osaka_expenses_2025', JSON.stringify(expenses)); }
                    if(data.notes) { infoNotes = data.notes; localStorage.setItem('osaka_notes_2025', JSON.stringify(infoNotes)); }
                    if(data.shopping) { shoppingData = data.shopping; localStorage.setItem('osaka_shopping_2025', JSON.stringify(shoppingData)); }
                    alert('åŒ¯å…¥æˆåŠŸï¼è«‹é‡æ–°æ•´ç†é é¢ã€‚'); location.reload();
                } catch(err) { alert('æª”æ¡ˆæ ¼å¼éŒ¯èª¤'); }
            };
            reader.readAsText(file);
        }

        function updateStatus(online) {
            const el = document.getElementById('connection-status');
            el.className = online ? 'status-online' : 'status-offline';
            el.title = online ? 'å·²é€£ç·šåŒæ­¥ä¸­' : 'å–®æ©Ÿæ¨¡å¼ (æœªåŒæ­¥)';
        }

        function switchPage(p) {
            document.querySelectorAll('.page').forEach(e=>e.classList.remove('active'));
            document.getElementById('page-'+p).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(e=>{e.classList.remove('active','text-stone-800');e.classList.add('text-stone-300')});
            document.getElementById('nav-'+p).classList.add('active','text-stone-800');
            document.getElementById('nav-'+p).classList.remove('text-stone-300');
            lucide.createIcons();
            if(p==='flight' && mapInstance) setTimeout(()=>mapInstance.invalidateSize(),100);
        }

        function copyAddress(text) {
            const temp = document.createElement("textarea");
            temp.value = text;
            document.body.appendChild(temp);
            temp.select();
            document.execCommand("copy");
            document.body.removeChild(temp);
            alert("åœ°å€å·²è¤‡è£½ï¼");
        }

        async function resetItineraryData() {
            if (!confirm('è­¦å‘Šï¼šç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è¡Œç¨‹è³‡æ–™å—ï¼Ÿé€™å°‡ç„¡æ³•å¾©åŸï¼Œä½†å¯ä»¥è§£æ±ºèˆŠè¡Œç¨‹åˆªä¸æ‰çš„å•é¡Œã€‚')) return;

            // Clear local storage flag to allow re-seeding
            localStorage.removeItem('osaka_itinerary_seeded');
            
            // Clear local data array
            itineraryData = [];
            renderItineraryList();

            try {
                if (db) {
                    const collectionRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('itinerary');
                    // Fetch all docs and delete them one by one (Firestore doesn't have a single clear command)
                    const snapshot = await collectionRef.get();
                    if (snapshot.size === 0) {
                        alert('è¡Œç¨‹è³‡æ–™å·²æ¸…ç©ºã€‚App å°‡è‡ªå‹•é‡æ–°è¼‰å…¥é è¨­è¡Œç¨‹ã€‚');
                        location.reload();
                        return;
                    }

                    const batch = db.batch();
                    snapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();

                    alert('è¡Œç¨‹è³‡æ–™å·²æ¸…ç©ºä¸¦é‡è¨­æˆåŠŸã€‚');
                    location.reload();
                } else {
                    throw new Error("Firebase not connected.");
                }
            } catch (e) {
                console.error("Reset failed", e);
                alert('é‡è¨­å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œåœ¨ Firebase å¾Œå°æ‰‹å‹•åˆªé™¤ã€‚');
            }
        }


        // --- SYNC LISTENERS ---
        function setupSyncListeners() {
            if(!db) return;
            const publicRef = db.collection('artifacts').doc(appId).collection('public').doc('data');
            
            // Itinerary
            publicRef.collection('itinerary').onSnapshot(snap => {
                const fetched = snap.docs.map(d => ({id: d.id, ...d.data()}));
                
                // FIX: Prevent re-seeding loop. Only seed if cloud collection is empty AND we haven't seeded before.
                if (snap.docs.length === 0) { 
                    if (!localStorage.getItem('osaka_itinerary_seeded')) { 
                        DEFAULT_ITINERARY.forEach(async f => {
                            // Use .set() with hardcoded ID
                            await publicRef.collection('itinerary').doc(f.id).set({...f, created: Date.now()});
                        });
                        localStorage.setItem('osaka_itinerary_seeded', 'true');
                    }
                    itineraryData = []; // Clear local state if cloud is truly empty
                } else { 
                    itineraryData = fetched; 
                    renderItineraryList();
                    // If successfully fetched data, mark as seeded
                    if (fetched.length > 0) localStorage.setItem('osaka_itinerary_seeded', 'true');
                }

            }, () => updateStatus(false));

            // Settings (Header Image)
            publicRef.collection('settings').doc('header').onSnapshot(doc => {
                if(doc.exists && doc.data().img) {
                    const img = doc.data().img;
                    // Only update if different to avoid flicker
                    if(img !== userHeaderImage) {
                        userHeaderImage = img;
                        localStorage.setItem('osaka_header_img', userHeaderImage);
                        document.getElementById('daily-scenic-img').src = userHeaderImage;
                    }
                }
            });

            // Settings (Map Image) - NEW SYNC LISTENER
            publicRef.collection('settings').doc('map').onSnapshot(doc => {
                if(doc.exists && doc.data().img) {
                    const img = doc.data().img;
                    if(img !== userMapImage) {
                        userMapImage = img;
                        localStorage.setItem('osaka_map_img', userMapImage);
                        document.getElementById('user-map-img').src = userMapImage;
                        initMapZoom(); // Reset zoom when new map loads
                    }
                }
            });

            publicRef.collection('luggage').onSnapshot(snap => {
                const fetched = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => a.created - b.created);
                if(fetched.length > 0) { luggageData = fetched; renderLuggage(); }
            });
            publicRef.collection('expenses').onSnapshot(snap => {
                const fetched = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => b.created - a.created);
                if(fetched.length > 0) { expenses = fetched; renderExpenses(); }
            });
            publicRef.collection('notes').onSnapshot(snap => {
                const fetched = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => a.created - b.created);
                if(fetched.length > 0) { infoNotes = fetched; renderInfoNotes(); }
            });
            publicRef.collection('shopping').onSnapshot(snap => {
                const fetched = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => b.created - a.created);
                if(fetched.length > 0) { shoppingData = fetched; renderShopping(); }
            });
        }

        // --- LOCAL FALLBACKS ---
        function initItineraryLocal() { const s = localStorage.getItem('osaka_itinerary_2025_v5'); itineraryData = s ? JSON.parse(s) : JSON.parse(JSON.stringify(DEFAULT_ITINERARY)); }
        function initLuggageLocal() { const s = localStorage.getItem('osaka_luggage_2025_v2'); luggageData = s ? JSON.parse(s) : []; renderLuggage(); }
        function initExpensesLocal() { const s = localStorage.getItem('osaka_expenses_2025'); expenses = s ? JSON.parse(s) : []; renderExpenses(); }
        function initInfoNotesLocal() { const s = localStorage.getItem('osaka_notes_2025'); infoNotes = s ? JSON.parse(s) : []; renderInfoNotes(); }
        function initShoppingLocal() { const s = localStorage.getItem('osaka_shopping_2025'); shoppingData = s ? JSON.parse(s) : []; renderShopping(); }

        // --- WEATHER API ---
        async function fetchWeather() {
            try {
                // Open-Meteo API: Osaka
                const res = await fetch("https://api.open-meteo.com/v1/forecast?latitude=34.6937&longitude=135.5022&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=Asia%2FTokyo");
                const data = await res.json();
                
                if (data && data.daily) {
                    // Reset weather data
                    weatherData = [];
                    // Map first 6 days
                    for(let i=0; i<6; i++) {
                        if (data.daily.time[i]) {
                            const code = data.daily.weathercode[i];
                            const min = Math.round(data.daily.temperature_2m_min[i]);
                            const max = Math.round(data.daily.temperature_2m_max[i]);
                            weatherData.push({
                                icon: getWeatherIcon(code),
                                temp: `${min}Â°/${max}Â°`
                            });
                        }
                    }
                    initWeather(); // Re-render
                }
            } catch (e) {
                console.error("Weather fetch failed", e);
                // Fallback is already loaded
            }
        }

        function getWeatherIcon(code) {
            // WMO Weather Codes
            if (code === 0) return 'â˜€ï¸'; // Clear
            if (code >= 1 && code <= 3) return 'â›…'; // Cloudy
            if (code >= 45 && code <= 48) return 'ğŸŒ«ï¸'; // Fog
            if (code >= 51 && code <= 67) return 'ğŸŒ§ï¸'; // Rain
            if (code >= 71 && code <= 77) return 'â„ï¸'; // Snow
            if (code >= 80 && code <= 82) return 'ğŸŒ§ï¸'; // Showers
            if (code >= 95) return 'â›ˆï¸'; // Thunderstorm
            return 'â˜ï¸';
        }

        function initWeather() {
            const c = document.getElementById('weather-strip');
            c.innerHTML = '';
            weatherData.forEach((w,i)=>{
                const d=new Date(TRIP_START);
                d.setDate(TRIP_START.getDate()+i);
                const isToday=i===currentDayIndex;
                const el=document.createElement('div');
                el.className=`weather-card flex flex-col items-center justify-center p-2 rounded-lg min-w-[70px] border transition-all cursor-pointer ${isToday?'bg-white border-stone-300 shadow-sm':'bg-transparent border-transparent opacity-60'}`;
                el.onclick=()=>setDay(i);
                el.innerHTML=`<span class="text-[10px] font-bold text-stone-400 mb-1">${d.getMonth()+1}/${d.getDate()} (${WEEKDAYS[d.getDay()]})</span><span class="text-xl mb-1">${w.icon}</span><span class="text-[10px] font-bold text-stone-600">${w.temp}</span>`;
                c.appendChild(el);
            });
        }

        // --- ITINERARY ---
        function renderItineraryList(){
            const l=document.getElementById('itinerary-list');l.innerHTML='';
            const d=itineraryData.filter(i=>parseInt(i.day)===currentDayIndex).sort((a,b)=>a.time.localeCompare(b.time));
            if(d.length===0){l.innerHTML=`<div class="text-center py-10 opacity-30"><p class="text-xs">å°šç„¡è¡Œç¨‹</p></div>`;return;}
            d.forEach(i=>{
                // NEW COLOR SCHEME (Minimalist & Low Saturation)
                // Default border color is stone-100 if type doesn't match
                let borderClass = 'border-l-stone-100';
                let iconColor = 'text-stone-300';
                let iconName = 'map-pin';
                let badgeClass = 'bg-stone-50 text-stone-500'; // Default Badge

                if(i.type==='food'){
                    // æŸ”å’Œæ‹¿éµè‰² (Latte - using arbitrary value or mix)
                    borderClass = 'border-l-[#C7B299]'; 
                    iconColor = 'text-[#8C7B70]'; 
                    iconName = 'utensils';
                    badgeClass = 'bg-[#F5F0EB] text-[#8C7B70]';
                }
                else if(i.type==='shop'){
                    // æŸ”å’Œéœ§éœ¾è— (Haze Blue)
                    borderClass = 'border-l-[#94A3B8]';
                    iconColor = 'text-[#475569]';
                    iconName = 'shopping-bag';
                    badgeClass = 'bg-[#F1F5F9] text-[#475569]';
                }
                else if(i.type==='flight'){
                    // æŸ”å’Œä¹¾ç‡¥ç«ç‘°/æ©˜ (Dried Rose/Terracotta)
                    borderClass = 'border-l-[#ECA9A9]';
                    iconColor = 'text-[#991B1B]';
                    iconName = 'plane';
                    badgeClass = 'bg-[#FEF2F2] text-[#991B1B]';
                }
                else if(i.type==='spot'){
                    // æŸ”å’Œæš–ç° (Warm Gray)
                    borderClass = 'border-l-[#A8A29E]';
                    iconColor = 'text-[#57534E]';
                    iconName = 'map-pin';
                    badgeClass = 'bg-[#F5F5F4] text-[#57534E]';
                }

                const u=`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(i.location||i.title)}`;
                const el=document.createElement('div');
                // ä¸»è¦æ”¹è®Šï¼šbg-white, border-l-4 (åŠ ç²—å·¦å´ç·šæ¢), ç§»é™¤æ•´é«”é‚Šæ¡†é¡è‰²(except subtle stone-100)
                el.className=`flex flex-col p-4 rounded-xl bg-white border border-stone-100 ${borderClass} border-l-4 relative group transition-all mb-2 shadow-sm`;
                el.innerHTML=`
                    <div class="flex items-center">
                        <div class="mr-4 text-center min-w-[3.5rem]"><div class="text-lg font-bold font-mono text-stone-800 leading-none">${i.time}</div></div>
                        <div class="flex-1 border-l border-stone-100 pl-4 py-1">
                            <div class="flex justify-between items-start"><h3 class="font-bold text-stone-800 text-sm">${i.title}</h3></div>
                            <div class="flex items-center mt-1">
                                <span class="px-2 py-0.5 rounded text-[10px] font-bold ${badgeClass} mr-2 uppercase tracking-wide">${i.type}</span>
                                ${i.location&&i.location!==i.title?`<span class="text-[10px] text-stone-400 truncate max-w-[120px] flex items-center"><i data-lucide="map-pin" class="inline w-2 h-2 mr-1"></i>${i.location}</span>`:''}
                            </div>
                        </div>
                        <div class="flex flex-col gap-2 ml-2">
                            <a href="${u}" target="_blank" class="p-2 bg-white border border-stone-100 rounded-full text-stone-400 hover:text-blue-600 shadow-sm"><i data-lucide="navigation" class="w-4 h-4"></i></a>
                            <div class="flex gap-1">
                                <button onclick="openEditModal('${i.id}')" class="p-2 bg-white border border-stone-100 rounded-full text-stone-400 hover:text-stone-800 shadow-sm"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                                <button onclick="deleteItinerary('${i.id}')" class="p-2 bg-white border border-stone-100 rounded-full text-stone-400 hover:text-red-500 shadow-sm"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                    </div>
                    ${i.note ? `<div class="mt-3 ml-[4.5rem] bg-stone-50 p-2 rounded text-xs text-stone-500 flex items-start"><i data-lucide="sticky-note" class="w-3 h-3 mr-1.5 mt-0.5 opacity-50 flex-shrink-0"></i>${i.note}</div>` : ''}
                `;
                l.appendChild(el);
            });
            // Map
            const m=d.filter(i=>i.lat&&i.lng);
            const mc=document.createElement('div');
            mc.className="mt-6 overflow-hidden rounded-2xl shadow-md border border-stone-200 bg-white";
            mc.innerHTML=`<div class="h-64 w-full relative z-0" id="map-wrap-${currentDayIndex}"></div><div class="p-3 bg-white text-center border-t border-stone-100"><a href="#" id="google-maps-btn" target="_blank" class="block w-full py-2 bg-blue-50 text-blue-600 rounded-lg text-xs font-bold hover:bg-blue-100 transition-colors"><i data-lucide="external-link" class="w-3 h-3 inline mr-1"></i> é–‹å•Ÿ Google Maps å°èˆª</a></div>`;
            l.appendChild(mc);
            setTimeout(()=>{
                const mid=`map-wrap-${currentDayIndex}`;
                if(document.getElementById(mid)){
                    if(mapInstance){mapInstance.remove();mapInstance=null;}
                    const c=m.length>0?[m[0].lat,m[0].lng]:[34.6937,135.5023];
                    mapInstance=L.map(mid).setView(c,13);
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{attribution:'&copy; OSM',maxZoom:19}).addTo(mapInstance);
                    const b=[];
                    m.forEach(i=>{L.marker([i.lat,i.lng]).addTo(mapInstance).bindPopup(i.title);b.push([i.lat,i.lng]);});
                    if(b.length>1)mapInstance.fitBounds(b,{padding:[50,50]});
                    const q=m.map(i=>i.title).join('/');
                    document.getElementById('google-maps-btn').href=m.length?`https://www.google.com/maps/dir/${q}`:`https://www.google.com/maps/search/Osaka`;
                }
            },100);
            lucide.createIcons();
        }
        
        async function saveItineraryItem() {
            const id = document.getElementById('edit-id').value;
            const title = document.getElementById('new-title').value;
            const location = document.getElementById('new-location').value;
            const time = document.getElementById('new-time').value;
            const note = document.getElementById('new-note').value;
            const day = parseInt(document.getElementById('new-day').value);
            const type = document.querySelector('input[name="new-type"]:checked').value;
            let lat = parseFloat(document.getElementById('new-lat').value);
            let lng = parseFloat(document.getElementById('new-lng').value);
            if(!title || !time) return alert('è«‹å¡«å¯«å®Œæ•´');
            // FIX: Allow saving if location is not set, but prevent saving without coordinates unless it's a flight
            if (!lat || !lng) {
                if (type !== 'flight') {
                    return alert('è«‹é»æ“Šåœ°åœ–æ¨™è¨˜åœ°é»åæ¨™ï¼');
                } else {
                    // For flights, use hardcoded generic coordinates if none set
                    lat = 0; lng = 0; 
                }
            }
            const itemData = { title, location: location || title, time, day, type, note, lat, lng, created: Date.now() };
            try {
                if(db) {
                    if(id) {
                        // FIX: Use set with merge to ensure default items sync properly
                        await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('itinerary').doc(id).set(itemData, {merge: true});
                    }
                    else await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('itinerary').add(itemData);
                } else throw new Error();
            } catch(e) {
                if(id) itineraryData = itineraryData.map(i => i.id === id ? { ...i, ...itemData, id } : i);
                else itineraryData.push({ ...itemData, id: Date.now().toString() });
                localStorage.setItem('osaka_itinerary_2025_v5', JSON.stringify(itineraryData));
                renderItineraryList();
            }
            closeAddModal();
        }
        async function deleteItinerary(id) {
            if(!confirm('ç¢ºèªåˆªé™¤ï¼Ÿ')) return;
            
            // Optimistic update: Remove from UI immediately
            const originalData = [...itineraryData];
            itineraryData = itineraryData.filter(i => i.id !== id);
            renderItineraryList();

            try { 
                if(db) await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('itinerary').doc(id).delete(); 
                else throw new Error(); 
                
            } catch(e) {
                console.error('Delete failed:', e);
                // Rollback UI if delete failed
                itineraryData = originalData;
                renderItineraryList();
                alert('åˆªé™¤å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦ã€‚'); 
            }
        }

        // --- GEOLOCATION (New Feature) ---
        // Removed GeocodeLocation() as it was the source of issues.

        function updateGoogleMapsLink() {
            const query = document.getElementById('new-location').value.trim();
            const link = document.getElementById('google-maps-link');
            const feedback = document.getElementById('map-search-feedback');
            
            if (query.length > 2) {
                const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}%2C%20Osaka%2C%20Japan`;
                link.href = url;
                link.classList.remove('hidden');
                link.classList.add('flex');
                
                feedback.innerHTML = `<i data-lucide="map-pin" class="w-3 h-3 mr-1 text-blue-600"></i> è«‹é»æ“Šä¸Šæ–¹é€£çµè‡³ Google Maps æœå°‹ç²¾ç¢ºä½ç½®ï¼Œç„¶å¾Œ**å›åˆ°æ­¤é åœ¨åœ°åœ–ä¸Šé»æ“Š**ã€‚`;
                feedback.classList.remove('text-red-500');
                feedback.classList.add('text-blue-600');
            } else {
                link.classList.add('hidden');
                link.classList.remove('flex');
                
                feedback.innerHTML = `<i data-lucide="map-pin" class="w-3 h-3 mr-1 text-red-500"></i> è«‹è¼¸å…¥åœ°é»å¾Œï¼Œé»æ“Šåœ°åœ–æ¨™è¨˜ç²¾ç¢ºä½ç½®ã€‚`;
                feedback.classList.remove('text-blue-600');
                feedback.classList.add('text-red-500');
            }
            lucide.createIcons();
        }


        // --- SHOPPING ---
        function handleShopImg(e) {
            const f = e.target.files[0];
            if(f) {
                const r = new FileReader();
                r.onload = async function(evt) {
                    tempShopImg = await compressImage(evt.target.result, 800, 0.7); // Compress
                    document.getElementById('shop-img-preview').src = tempShopImg;
                    document.getElementById('shop-img-preview').classList.remove('hidden');
                    document.getElementById('shop-img-placeholder').classList.add('hidden');
                };
                r.readAsDataURL(f);
            }
        }
        async function addShopItem() {
            const name = document.getElementById('shop-name').value;
            const note = document.getElementById('shop-note').value;
            if(!name) return alert('è«‹è¼¸å…¥å•†å“åç¨±');
            const itemData = { name, note, img: tempShopImg || '', checked: false, created: Date.now() };
            try {
                if(db) await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('shopping').add(itemData);
                else throw new Error();
            } catch(e) {
                shoppingData.unshift(itemData); renderShopping(); localStorage.setItem('osaka_shopping_2025', JSON.stringify(shoppingData));
            }
            // Reset UI
            document.getElementById('shop-name').value = '';
            document.getElementById('shop-note').value = '';
            document.getElementById('shop-img-preview').src = '';
            document.getElementById('shop-img-preview').classList.add('hidden');
            document.getElementById('shop-img-placeholder').classList.remove('hidden');
            tempShopImg = null;
        }
        async function deleteShop(id) {
            if(!confirm('ç¢ºèªåˆªé™¤ï¼Ÿ')) return;
            try { if(db) await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('shopping').doc(id).delete(); else throw new Error(); } catch(e) {
                shoppingData = shoppingData.filter(i => i.id !== id); renderShopping(); localStorage.setItem('osaka_shopping_2025', JSON.stringify(shoppingData));
            }
        }
        function renderShopping() {
            const l = document.getElementById('shopping-list');
            l.innerHTML = '';
            shoppingData.forEach(i => {
                const d = document.createElement('div');
                d.className = 'bg-white rounded-xl shadow-sm border border-stone-200 overflow-hidden relative group';
                d.innerHTML = `
                    <div class="h-32 w-full bg-stone-100 flex items-center justify-center overflow-hidden">
                        ${i.img ? `<img src="${i.img}" class="w-full h-full object-cover">` : `<i data-lucide="image" class="w-8 h-8 text-stone-300"></i>`}
                    </div>
                    <div class="p-3">
                        <div class="font-bold text-stone-800 text-sm truncate">${i.name}</div>
                        <div class="text-xs text-stone-400 mt-1 truncate">${i.note || 'ç„¡å‚™è¨»'}</div>
                    </div>
                    <button onclick="deleteShop('${i.id}')" class="absolute top-2 right-2 bg-black/50 text-white p-1.5 rounded-full opacity-0 group-hover:opacity-100 transition-opacity"><i data-lucide="x" class="w-3 h-3"></i></button>
                `;
                l.appendChild(d);
            });
            lucide.createIcons();
        }

        // --- LUGGAGE ---
        async function addLuggageItem(){const v=document.getElementById('new-luggage-item').value;if(!v)return;try{if(db)await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('luggage').add({text:v,checked:false,created:Date.now()});else throw new Error();}catch(e){luggageData.push({id:Date.now(),text:v,checked:false});renderLuggage();localStorage.setItem('osaka_luggage_2025_v2',JSON.stringify(luggageData));}document.getElementById('new-luggage-item').value='';}
        async function toggleLuggage(id,old){try{if(db)await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('luggage').doc(id).update({checked:!old});else throw new Error();}catch(e){luggageData=luggageData.map(i=>i.id===id?{...i,checked:!old}:i);renderLuggage();localStorage.setItem('osaka_luggage_2025_v2',JSON.stringify(luggageData));}}
        async function deleteLuggage(id){try{if(db)await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('luggage').doc(id).delete();else throw new Error();}catch(e){luggageData=luggageData.filter(i=>i.id!==id);renderLuggage();localStorage.setItem('osaka_luggage_2025_v2',JSON.stringify(luggageData));}}
        function renderLuggage(){const c=document.getElementById('luggage-list');c.innerHTML='';const d=luggageData.filter(i=>i.checked).length;document.getElementById('luggage-count').innerText=`${d}/${luggageData.length}`;document.getElementById('progress-bar').style.width=luggageData.length?(d/luggageData.length)*100+'%':'0%';luggageData.forEach(i=>{const el=document.createElement('div');el.className='flex items-center justify-between p-3 bg-white border border-stone-200 rounded-lg group hover:shadow-sm transition-all';el.innerHTML=`<label class="flex items-center flex-1 cursor-pointer select-none"><input type="checkbox" class="w-5 h-5 rounded border-stone-300 text-stone-800 focus:ring-stone-500 mr-3" ${i.checked?'checked':''} onchange="toggleLuggage('${i.id}',${i.checked})"><span class="${i.checked?'line-through text-stone-300':'text-stone-700'} text-sm font-medium transition-colors">${i.text}</span></label><button onclick="deleteLuggage('${i.id}')" class="opacity-0 group-hover:opacity-100 text-stone-300 hover:text-red-400 transition-all px-2"><i data-lucide="x" class="w-4 h-4"></i></button>`;c.appendChild(el);});lucide.createIcons();}

        // --- EXPENSES ---
        let showTWD=false;
        function calculateExchange(){document.getElementById('twd-output').innerText=Math.round((parseFloat(document.getElementById('jpy-input').value)||0)*0.215).toLocaleString();}
        async function addExpense(){
            const n=document.getElementById('expense-note').value;
            const a=parseInt(document.getElementById('expense-amt').value);
            const cat=document.getElementById('expense-cat').value;
            if(!n||isNaN(a))return;
            try{if(db)await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('expenses').add({note:n,amt:a,cat,created:Date.now()});else throw new Error();}catch(e){expenses.unshift({id:Date.now(),note:n,amt:a,cat});renderExpenses();localStorage.setItem('osaka_expenses_2025',JSON.stringify(expenses));}
            document.getElementById('expense-note').value='';document.getElementById('expense-amt').value='';
        }
        async function deleteExpense(id){try{if(db)await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('expenses').doc(id).delete();else throw new Error();}catch(e){expenses=expenses.filter(e=>e.id!==id);renderExpenses();localStorage.setItem('osaka_expenses_2025',JSON.stringify(expenses));}}
        function renderExpenses(){
            const c=document.getElementById('expense-list');c.innerHTML='';let t=0;
            // Cats totals
            let cats = {food:0, shop:0, trans:0, other:0};
            expenses.forEach(e=>{
                t+=e.amt;
                if(e.cat) cats[e.cat] += e.amt; else cats.other += e.amt;
                let catIcon = e.cat==='food'?'utensils':e.cat==='shop'?'shopping-bag':e.cat==='trans'?'bus':'circle-dollar-sign';
                const d=document.createElement('div');
                d.className='flex justify-between items-center py-3 border-b border-stone-100 last:border-0';
                d.innerHTML=`<div class="flex items-center"><button onclick="deleteExpense('${e.id}')" class="mr-3 text-stone-200 hover:text-red-400"><i data-lucide="minus-circle" class="w-4 h-4"></i></button><div class="mr-3 p-1.5 bg-stone-50 rounded text-stone-400"><i data-lucide="${catIcon}" class="w-3 h-3"></i></div><span class="text-sm text-stone-700 font-medium">${e.note}</span></div><span class="font-mono text-stone-600 font-bold tracking-tight">Â¥${e.amt.toLocaleString()}</span>`;
                c.appendChild(d);
            });
            const tel=document.getElementById('total-expense');
            tel.innerText=showTWD?`NT$ ${Math.round(t*0.215).toLocaleString()}`:`Â¥ ${t.toLocaleString()}`;
            
            // Chart Render
            const chart = document.getElementById('expense-chart');
            const legend = document.getElementById('expense-legend');
            if(t>0) {
                chart.innerHTML = `
                    <div style="width:${(cats.food/t)*100}%" class="h-full bg-amber-400"></div>
                    <div style="width:${(cats.shop/t)*100}%" class="h-full bg-blue-400"></div>
                    <div style="width:${(cats.trans/t)*100}%" class="h-full bg-emerald-400"></div>
                    <div style="width:${(cats.other/t)*100}%" class="h-full bg-stone-300"></div>
                `;
                legend.innerHTML = `
                    <span class="flex items-center text-amber-600"><div class="w-2 h-2 rounded-full bg-amber-400 mr-1"></div>é£Ÿ ${Math.round((cats.food/t)*100)}%</span>
                    <span class="flex items-center text-blue-600"><div class="w-2 h-2 rounded-full bg-blue-400 mr-1"></div>è³¼ ${Math.round((cats.shop/t)*100)}%</span>
                    <span class="flex items-center text-emerald-600"><div class="w-2 h-2 rounded-full bg-emerald-400 mr-1"></div>è¡Œ ${Math.round((cats.trans/t)*100)}%</span>
                    <span class="flex items-center text-stone-500"><div class="w-2 h-2 rounded-full bg-stone-300 mr-1"></div>ä»– ${Math.round((cats.other/t)*100)}%</span>
                `;
            } else { chart.innerHTML=''; legend.innerHTML=''; }

            lucide.createIcons();
        }
        function toggleTotalCurrency(){showTWD=!showTWD;renderExpenses();}
        
        // --- NOTES ---
        async function addInfoNote(){const v=document.getElementById('new-note-input').value;if(!v)return;try{if(db)await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('notes').add({text:v,created:Date.now()});else throw new Error();}catch(e){infoNotes.push({id:Date.now(),text:v});renderInfoNotes();localStorage.setItem('osaka_notes_2025',JSON.stringify(infoNotes));}document.getElementById('new-note-input').value='';}
        async function deleteInfoNote(id){try{if(db)await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('notes').doc(id).delete();else throw new Error();}catch(e){infoNotes=infoNotes.filter(n=>n.id!==id);renderInfoNotes();localStorage.setItem('osaka_notes_2025',JSON.stringify(infoNotes));}}
        function renderInfoNotes(){const l=document.getElementById('info-notes-list');l.innerHTML='';infoNotes.forEach(note=>{const d=document.createElement('div');d.className='flex justify-between items-center p-3 bg-stone-50 rounded-lg text-sm border border-stone-100 group';d.innerHTML=`<span class="text-stone-700">${note.text}</span><button onclick="deleteInfoNote('${note.id}')" class="text-stone-300 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity"><i data-lucide="x" class="w-4 h-4"></i></button>`;l.appendChild(d);});lucide.createIcons();}

        function initDateTabs(){const c=document.getElementById('date-tabs');const s=document.getElementById('new-day');for(let i=0;i<TOTAL_DAYS;i++){const d=new Date(TRIP_START);d.setDate(TRIP_START.getDate()+i);const m=d.getMonth()+1;const day=d.getDate();const w=WEEKDAYS[d.getDay()];const b=document.createElement('button');b.className=`date-tab flex-shrink-0 px-4 py-1.5 rounded-full text-xs font-bold border transition-all ${i===0?'bg-stone-800 text-white border-stone-800':'bg-white text-stone-400 border-stone-200'}`;b.innerText=`Day ${i+1} (${w})`;b.onclick=()=>setDay(i);c.appendChild(b);const o=document.createElement('option');o.value=i;o.text=`Day ${i+1} - ${m}/${day} (${w})`;s.appendChild(o);}updateHeaderImage(0);}
        function setDay(i){currentDayIndex=i;document.querySelectorAll('.date-tab').forEach((t,idx)=>{t.className=idx===i?'date-tab flex-shrink-0 px-4 py-1.5 rounded-full text-xs font-bold border transition-all bg-stone-800 text-white border-stone-800 shadow-md':'date-tab flex-shrink-0 px-4 py-1.5 rounded-full text-xs font-bold border transition-all bg-white text-stone-400 border-stone-200'});document.getElementById('header-day-num').innerText=i+1;updateHeaderImage(i);updateWeatherHighlight(i);renderItineraryList();}
        
        async function handleHeaderUpload(e){
            const f=e.target.files[0];
            if(f){
                const r=new FileReader();
                r.onload=async function(evt){
                    // Compress and sync to cloud
                    const compressed = await compressImage(evt.target.result, 1200, 0.7); // Larger size for header
                    userHeaderImage=compressed;
                    localStorage.setItem('osaka_header_img',userHeaderImage);
                    document.getElementById('daily-scenic-img').src=userHeaderImage;
                    
                    // Upload to Firebase
                    if(db) {
                        try {
                            await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('settings').doc('header').set({
                                img: userHeaderImage,
                                updated: Date.now()
                            });
                        } catch(err) {
                            console.error("Header upload failed", err);
                        }
                    }
                };
                r.readAsDataURL(f);
            }
        }
        
        async function handleMapUpload(e){
            const f=e.target.files[0];
            if(f){
                const r=new FileReader();
                r.onload=async function(evt){
                    // Compress and sync to cloud
                    const compressed = await compressImage(evt.target.result, 1920, 0.8); // High quality for map
                    userMapImage=compressed;
                    localStorage.setItem('osaka_map_img',userMapImage);
                    document.getElementById('user-map-img').src = userMapImage;
                    initMapZoom(); // Reset zoom state for new map

                    // Upload to Firebase
                    if(db) {
                        try {
                            await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('settings').doc('map').set({
                                img: userMapImage,
                                updated: Date.now()
                            });
                            alert("åœ°éµåœ°åœ–å·²ä¸Šå‚³ä¸¦åŒæ­¥åˆ°é›²ç«¯ï¼");
                        } catch(err) {
                            console.error("Map upload failed", err);
                            alert("åœ°åœ–åŒæ­¥åˆ°é›²ç«¯å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚");
                        }
                    } else {
                         alert("åœ°åœ–å·²ä¸Šå‚³åˆ°æœ¬æ©Ÿï¼Œä½†æœªåŒæ­¥åˆ°é›²ç«¯ (Firebaseé€£ç·šå¤±æ•—)ã€‚");
                    }
                };
                r.readAsDataURL(f);
            }
        }

        function updateHeaderImage(i){const img=document.getElementById('daily-scenic-img');img.style.opacity='0';setTimeout(()=>{img.src=userHeaderImage||SCENIC_IMAGES[i%SCENIC_IMAGES.length];img.onload=()=>img.style.opacity='1';},300);}
        function updateWeatherHighlight(idx){document.querySelectorAll('.weather-card').forEach((el,i)=>{if(i===idx){el.classList.add('bg-white','border-stone-300','shadow-sm','scale-105');el.classList.remove('bg-transparent','border-transparent','opacity-60');}else{el.classList.remove('bg-white','border-stone-300','shadow-sm','scale-105');el.classList.add('bg-transparent','border-transparent','opacity-60');}});}
        function openAddModal(){document.getElementById('add-modal').classList.remove('hidden');document.getElementById('new-day').value=currentDayIndex;document.getElementById('modal-title').innerText="æ–°å¢è¡Œç¨‹";document.getElementById('modal-btn-text').innerText="ç¢ºèªæ–°å¢";document.getElementById('edit-id').value="";document.getElementById('new-title').value="";document.getElementById('new-location').value="";document.getElementById('new-time').value="";document.getElementById('new-note').value="";document.getElementById('new-lat').value="";document.getElementById('new-lng').value="";
            // Reset feedback text
            document.getElementById('map-search-feedback').innerHTML = `<i data-lucide="map-pin" class="w-3 h-3 mr-1 text-red-500"></i> è«‹å…ˆé»æ“Šä¸Šæ–¹ **Google Maps é€£çµ** æŸ¥è©¢åæ¨™ï¼Œå†é»æ“Šä¸‹æ–¹çš„åœ°åœ–æ¨™è¨˜ã€‚`;
            updateGoogleMapsLink(); // Init the link visibility

            if(pickerMarker) pickerMarker.remove();
            setTimeout(()=>{ 
                if(!pickerMap) {
                    // Initialize Map Picker on modal opening
                    pickerMap=L.map('picker-map').setView([34.6937, 135.5023], 13);
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{attribution:'&copy; OSM',maxZoom:19}).addTo(pickerMap);
                    pickerMap.on('click', (e) => {
                        if(pickerMarker) pickerMarker.remove();
                        pickerMarker = L.marker(e.latlng).addTo(pickerMap);
                        document.getElementById('new-lat').value = e.latlng.lat.toFixed(6);
                        document.getElementById('new-lng').value = e.latlng.lng.toFixed(6);
                        // Clear successful search text, back to red prompt
                        document.getElementById('map-search-feedback').innerHTML = `<i data-lucide="check-circle" class="w-3 h-3 mr-1 text-green-600"></i> ä½ç½®å·²æ¨™è¨˜ï¼`;
                        document.getElementById('map-search-feedback').classList.remove('text-red-500');
                        document.getElementById('map-search-feedback').classList.add('text-green-600');
                        lucide.createIcons();
                    });
                }
                pickerMap.invalidateSize(); 
                pickerMap.setView([34.6937, 135.5023], 13); 
            }, 200);
        }
        function openEditModal(id){const item=itineraryData.find(i=>i.id===id);if(!item)return;document.getElementById('add-modal').classList.remove('hidden');document.getElementById('modal-title').innerText="ä¿®æ”¹è¡Œç¨‹";document.getElementById('modal-btn-text').innerText="å„²å­˜ä¿®æ”¹";document.getElementById('edit-id').value=id;document.getElementById('new-title').value=item.title;document.getElementById('new-location').value=item.location||"";document.getElementById('new-time').value=item.time;document.getElementById('new-day').value=item.day;document.getElementById('new-note').value=item.note||"";
            const radios=document.getElementsByName('new-type');for(let r of radios){if(r.value===item.type)r.checked=true;}
            // Reset feedback text
            document.getElementById('map-search-feedback').innerHTML = `<i data-lucide="map-pin" class="w-3 h-3 mr-1 text-red-500"></i> è«‹å…ˆé»æ“Šä¸Šæ–¹ **Google Maps é€£çµ** æŸ¥è©¢åæ¨™ï¼Œå†é»æ“Šä¸‹æ–¹çš„åœ°åœ–æ¨™è¨˜ã€‚`;
            updateGoogleMapsLink(); // Init the link visibility

            // Set map
            setTimeout(()=>{ 
                if(!pickerMap) openAddModal(); // Ensure map is initialized
                pickerMap.invalidateSize(); 
                if(item.lat && item.lng) {
                    if(pickerMarker) pickerMarker.remove();
                    pickerMarker = L.marker([item.lat, item.lng]).addTo(pickerMap);
                    pickerMap.setView([item.lat, item.lng], 15);
                    document.getElementById('new-lat').value = item.lat;
                    document.getElementById('new-lng').value = item.lng;
                    document.getElementById('map-search-feedback').innerHTML = `<i data-lucide="check-circle" class="w-3 h-3 mr-1 text-green-600"></i> ç›®å‰ä½ç½®å·²æ¨™è¨˜ã€‚`;
                    document.getElementById('map-search-feedback').classList.remove('text-red-500');
                    document.getElementById('map-search-feedback').classList.add('text-green-600');
                } else {
                    pickerMap.setView([34.6937, 135.5023], 13);
                }
                lucide.createIcons();
            }, 200);
        }
        function closeAddModal(){document.getElementById('add-modal').classList.add('hidden');}
        function openZoomCard(t,j,r){document.getElementById('zoom-modal').classList.remove('hidden');document.getElementById('zoom-modal').classList.add('flex');document.getElementById('zoom-title').innerText=t;document.getElementById('zoom-jp').innerHTML=j;document.getElementById('zoom-ro').innerText=r;}
        function closeZoomCard(){document.getElementById('zoom-modal').classList.add('hidden');document.getElementById('zoom-modal').classList.remove('flex');}
    </script>
</body>
</html>