<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSAKA FAMILY TRIP - æ›åŒ¯/è¨˜å¸³</title>
    <!-- Firebase Libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <style>
        /* CSS æ¨£å¼ï¼šå…¨éƒ¨æ¡ç”¨æ–°è‰² #955f47 */
        :root {
            --main-color: #955f47;
            --text-color: #382414;
            --white-bg: #ffffff;
            --light-bg: #f8f8f8;
            --emergency-red: #d9534f;
            --safe-green: #28a745;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--white-bg); /* ç™½åº• */
            color: var(--text-color);
            margin: 0;
            padding: 0;
            padding-top: 95px; 
            font-size: 14px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* å°èˆªæ¬„æ¨£å¼ (èˆ‡ flight.html ç›¸åŒ) */
        .fixed-nav-header {
            width: 100%;
            max-width: 600px;
            position: fixed;
            top: 0;
            z-index: 1000;
            background-color: var(--white-bg);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
        }

        .simple-title-bar { padding: 8px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
        .simple-title-text { text-align: center; flex-grow: 1; }
        .simple-title-text h1 { color: var(--main-color); font-size: 17px; margin: 0; line-height: 1.2; }
        .simple-title-text p { color: #666; font-size: 12px; margin: 0; }
        .simple-title-bar a { color: var(--text-color); text-decoration: none; font-size: 18px; margin: 0 5px; }

        .nav-bar-wrapper { display: flex; background-color: var(--white-bg); padding: 5px 0 10px 0; border-bottom: 1px solid #eee; justify-content: center; }
        .function-tabs { display: flex; justify-content: space-around; width: 100%; max-width: 580px; }
        .function-tab { padding: 5px 8px; color: #999; text-decoration: none; font-size: 11px; font-weight: 500; display: flex; flex-direction: column; align-items: center; }
        .function-tab.active { color: var(--main-color); }
        .function-icon { font-size: 20px; margin-bottom: 2px; line-height: 1; }

        /* ------------------------------------------------ */
        /* ----- é é¢å…§å®¹æ¨£å¼ (æ›åŒ¯/è¨˜å¸³) ----- */
        /* ------------------------------------------------ */
        .container { width: 100%; max-width: 600px; padding: 15px; margin: 0 auto; }
        
        .mode-container {
            padding: 20px;
            border-left: 5px solid transparent; 
            border-bottom: 1px solid #eee;
            border-radius: 4px;
            margin-top: 15px;
            background-color: #fafafa;
        }
        .mode-container.border-main { border-left-color: var(--main-color); }
        .mode-container h2 {
            margin-top: 0;
            font-size: 18px;
            color: var(--main-color);
            padding-bottom: 5px;
            border-bottom: 1px solid #f0f0f0;
        }
        .desc { font-size: 13px; color: #888; margin-bottom: 15px; }
        
        /* æ›ç®—å™¨æ¨£å¼ */
        .input-group {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: var(--white-bg);
            box-shadow: 0 1px 3px rgba(0,0,0,0.03);
        }
        .input-group label {
            display: block;
            font-weight: bold;
            color: var(--text-color);
            margin-bottom: 5px;
            font-size: 15px;
        }
        input[type="number"], input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 18px;
            text-align: center;
        }
        
        .currency-result {
            text-align: center;
            font-size: 15px;
            margin-top: 10px;
            color: #666;
        }
        .currency-result strong {
            font-size: 32px;
            color: var(--main-color);
            display: block;
            margin-top: 5px;
        }

        /* è¨˜å¸³æ¨£å¼ (ç·šæ¢æ¥µç°¡) */
        .summary {
            text-align: right;
            font-size: 16px;
            padding: 10px 0;
            border-top: 2px solid var(--main-color);
        }
        .section-title {
            font-size: 15px;
            font-weight: bold;
            color: var(--safe-green);
            margin-top: 25px;
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }

        .budget-item {
            display: flex;
            align-items: center;
            padding: 10px 10px 10px 5px;
            margin-bottom: 8px;
            border-left: 5px solid transparent; 
            border-bottom: 1px solid #f5f5f5;
            background-color: var(--white-bg);
            border-radius: 4px;
        }

        .budget-item.border-green { border-left-color: var(--safe-green); }
        
        .amount-col { font-weight: bold; color: var(--emergency-red); font-size: 16px; width: 80px; text-align: right; flex-shrink: 0; }
        .desc-col { flex-grow: 1; padding-left: 15px; border-left: 1px solid #eee; margin-left: 15px; }
        .desc-col strong { display: block; font-size: 15px; }
        .timestamp { font-size: 12px; color: #aaa; margin: 2px 0 0; }
        .delete-btn { background: none; border: none; color: #aaa; font-size: 20px; line-height: 1; cursor: pointer; margin-left: 10px; padding: 5px; }
    </style>
</head>
<body>
    <div class="fixed-nav-header">
        <div class="simple-title-bar">
            <a href="flight.html">âœ•</a> 
            <div class="simple-title-text">
                <h1>OSAKA FAMILY TRIP</h1>
                <p>å¤§é˜ªæ—…éŠ 2026</p>
            </div>
            <a href="info.html">â“˜</a>
        </div>
        
        <div class="nav-bar-wrapper">
            <div class="function-tabs">
                <a href="flight.html" class="function-tab">
                    <span class="function-icon">ğŸ“…</span><span>è¡Œç¨‹</span>
                </a>
                <a href="checklist.html" class="function-tab">
                    <span class="function-icon">ğŸ§³</span><span>è¡Œæ</span>
                </a>
                <a href="exchange.html?mode=rate" id="rateTab" class="function-tab">
                    <span class="function-icon">ğŸ’´</span><span>æ›åŒ¯</span>
                </a>
                <a href="exchange.html?mode=budget" id="budgetTab" class="function-tab">
                    <span class="function-icon">ğŸ§¾</span><span>è¨˜å¸³</span>
                </a>
                <a href="info.html" class="function-tab">
                    <span class="function-icon">ğŸš¨</span><span>è³‡è¨Š</span>
                </a>
            </div>
        </div>
    </div>

    <div class="container">
        
        <div id="contentArea">
            <p style="text-align: center; color: #999; margin-top: 50px;">è¼‰å…¥æ›åŒ¯/è¨˜å¸³åŠŸèƒ½ä¸­...</p>
        </div>

    </div>

    <!-- åº•éƒ¨æŒ‰éˆ•å’Œå½ˆçª—ï¼ˆåœ¨è¨˜å¸³æ¨¡å¼ä¸‹é¡¯ç¤ºï¼‰ -->
    <div class="add-button-container" id="addButtonContainer" style="display:none;">
        <button id="addButton">ï¼‹ è¨˜ä¸€ç­†</button>
    </div>

    <div id="expenseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>æ–°å¢æ¬¾é …</h2>
                <span class="close-btn" id="closeModal">&times;</span>
            </div>
            
            <form id="expenseForm">
                <div class="input-form-group">
                    <label for="itemName">é …ç›®åç¨± (ä¾‹å¦‚ï¼šè¶…å•†é›¶é£Ÿ)</label>
                    <input type="text" id="itemName" placeholder="å¿…å¡«" required>
                </div>

                <div class="input-form-group">
                    <label for="jpyAmount">æ—¥å¹£é‡‘é¡</label>
                    <input type="number" id="jpyAmount" placeholder="0" required>
                    <div class="conversion-tip" id="twdConversion">ç´„ç­‰æ–¼å°å¹£ (TWD): 0</div>
                </div>
                
                <div class="input-form-group">
                    <label>ä»˜æ¬¾äºº (æœªä¾†å¯é»é¸é ­åƒ)</label>
                    <input type="text" value="K" disabled> 
                </div>

                <button type="submit" style="width: 100%; padding: 10px; background-color: var(--main-color); color: white; border: none; border-radius: 6px; font-size: 14px; margin-top: 10px;">å„²å­˜è‡³é›²ç«¯</button>
            </form>
        </div>
    </div>


    <script>
        // ----------------------------------------------------
        // ã€é›²ç«¯é…ç½®å€ã€‘è«‹å‹¿æ›´å‹•ä¸‹æ–¹çµæ§‹
        // ----------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyBGmvolsS8AgPfm09qynSVIz5GOcvXDKCM",
            authDomain: "osaka-family-trip.firebaseapp.com",
            databaseURL: "https://osaka-family-trip-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "osaka-family-trip",
            storageBucket: "osaka-family-trip.firebasestorage.app",
            messagingSenderId: "303743481222",
            appId: "1:303743481222:web:e3e4ecb51ff89a3acfe807"
        };
        
        let database;
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
        } catch (error) {
            console.error("Firebase Initialization Error:", error);
        }
        
        let currentFilter = 'All'; 
        const currentRate = 0.22; 
        const urlParams = new URLSearchParams(window.location.search);
        const mode = urlParams.get('mode') || 'rate'; 

        const contentArea = document.getElementById('contentArea');
        const addButtonContainer = document.getElementById('addButtonContainer');
        const rateTab = document.getElementById('rateTab');
        const budgetTab = document.getElementById('budgetTab');
        
        // æ ¹æ“š URL åƒæ•¸å•Ÿç”¨ç•¶å‰é é¢çš„ Active æ¨£å¼
        if (mode === 'budget') {
            rateTab.classList.remove('active');
            budgetTab.classList.add('active');
        } else {
            rateTab.classList.add('active');
            budgetTab.classList.remove('active');
        }


        // ----------------------------------------------------
        // è¨˜å¸³åˆ—è¡¨æ¸²æŸ“èˆ‡é‚è¼¯
        // ----------------------------------------------------
        function renderBudgetList() {
            // (å…§å®¹æ¸²æŸ“èˆ‡ Firebase é‚è¼¯...)
            addButtonContainer.style.display = 'flex';
            contentArea.innerHTML = `
                <div class="mode-container border-main">
                    <h2>ğŸ§¾ æ—…è²»æ”¯å‡ºè¨˜å¸³</h2>
                    <p class="desc">æ‰€æœ‰æ”¯å‡ºæœƒä»¥æ—¥å¹£ (JPY) è¨˜éŒ„ã€‚</p>

                    <div class="input-area">
                        <input type="number" id="amountInput" placeholder="é‡‘é¡ JPY (å¿…å¡«)" min="1">
                        <input type="text" id="descriptionInput" placeholder="æè¿°/é …ç›® (å¿…å¡«)">
                        <button id="addBudgetBtn">ï¼‹ ç´€éŒ„</button>
                    </div>
                    
                    <div id="summary" class="summary">
                        <p>ç¸½æ”¯å‡º (JPY): <strong id="totalJpy">0</strong></p>
                    </div>
                    
                    <div class="section-title" style="color: var(--safe-green);">æ”¯å‡ºç´€éŒ„</div>
                    <div id="budgetList">
                        <p style="text-align: center; color: #999;">è¼‰å…¥æ”¯å‡ºç´€éŒ„ä¸­...</p>
                    </div>
                </div>
            `;
            
            // Attach event listeners for budget mode
            document.getElementById('addBudgetBtn').addEventListener('click', addBudgetItem);
            document.getElementById('descriptionInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    document.getElementById('addBudgetBtn').click();
                }
            });
            
            // Start listening to Firebase
            if (database) {
                const budgetRef = database.ref('trip_budget');
                budgetRef.on('value', (snapshot) => {
                    const items = snapshot.val();
                    const itemsArray = items ? Object.keys(items).map(key => ({ ...items[key], key })) : [];
                    renderBudgetListContent(itemsArray);
                });
            } else {
                 document.getElementById('budgetList').innerHTML = '<p style="text-align: center; color: red;">ç„¡æ³•é€£æ¥ Firebaseï¼Œè«‹æª¢æŸ¥è¦å‰‡å’Œé…ç½®ç¢¼ï¼</p>';
            }
        }

        function renderBudgetListContent(items) {
            const listElement = document.getElementById('budgetList');
            const summaryElement = document.getElementById('totalJpy');
            if (!listElement || !summaryElement) return;

            let totalJpy = 0;
            const sortedItems = items.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0)); 

            const listHtml = sortedItems.map(item => {
                const amount = item.amount || 0;
                totalJpy += amount;
                const timeString = item.createdAt ? new Date(item.createdAt).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' }) : 'NA';

                return `
                    <div class="budget-item border-green" data-id="${item.key}">
                        <div class="amount-col">Â¥ ${amount.toLocaleString()}</div>
                        <div class="desc-col">
                            <strong>${item.description}</strong>
                            <p class="timestamp">${timeString}</p>
                        </div>
                        <button class="delete-btn" onclick="deleteBudgetItem('${item.key}')">&times;</button>
                    </div>
                `;
            }).join('');

            listElement.innerHTML = listHtml;
            summaryElement.textContent = totalJpy.toLocaleString();
        }

        function addBudgetItem() {
            const amountInput = document.getElementById('amountInput');
            const descInput = document.getElementById('descriptionInput');
            
            const amount = parseInt(amountInput.value);
            const description = descInput.value.trim();
            
            if (isNaN(amount) || amount <= 0 || !description) {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡åŠæè¿°ã€‚');
                return;
            }
            if (!database) return;

            const budgetRef = database.ref('trip_budget');
            budgetRef.push({
                amount: amount,
                description: description,
                createdAt: firebase.database.ServerValue.TIMESTAMP 
            }).then(() => {
                amountInput.value = '';
                descInput.value = '';
            }).catch(error => {
                console.error("Error adding budget item:", error);
            });
        }
        
        window.deleteBudgetItem = function(id) {
            if (!database) return;
            if(confirm('ç¢ºèªåˆªé™¤æ­¤ç­†æ”¯å‡ºç´€éŒ„ï¼Ÿ')) {
                database.ref(`trip_budget/${id}`).remove().catch(error => {
                    console.error("Error deleting item:", error);
                });
            }
        }
        
        // --- Mode 1: Rate Calculator ---
        function renderRateCalculator() {
            addButtonContainer.style.display = 'none';
            contentArea.innerHTML = `
                <div class="mode-container border-main">
                    <h2>ğŸ’´ æ›åŒ¯è¨ˆç®—å™¨</h2>
                    <p class="desc">å°‡å°å¹£ (TWD) å¿«é€Ÿæ›ç®—æˆæ—¥å¹£ (JPY)ã€‚</p>

                    <div class="input-group">
                        <label for="twdInput">å°å¹£é‡‘é¡ (TWD)</label>
                        <input type="number" id="twdInput" placeholder="è¼¸å…¥å°å¹£é‡‘é¡" value="100">
                    </div>
                    
                    <div class="currency-result">
                        ç´„ç­‰æ–¼æ—¥å¹£ (JPY): 
                        <strong><span id="jpyOutput">0</span></strong>
                    </div>

                    <div class="rate-info">
                        <p style="margin: 5px 0 0; font-size: 13px; color: #666;">ï¼ˆç›®å‰å‡è¨­åŒ¯ç‡ï¼š1 TWD = <span id="currentRate">4.60</span> JPYï¼‰</p>
                    </div>
                </div>
            `;
            
            document.getElementById('twdInput').addEventListener('input', calculateConversion);
            document.getElementById('twdInput').value = 100;
            calculateConversion(); 
        }

        function calculateConversion() {
            const twd = parseFloat(document.getElementById('twdInput').value) || 0;
            const rate = 4.60; 
            const jpy = twd * rate;
            document.getElementById('jpyOutput').textContent = jpy.toFixed(0).toLocaleString();
        }


        // --- Initialization ---
        window.onload = () => {
            // Render the view based on URL parameter
            if (mode === 'budget') {
                renderBudgetTracker();
            } else {
                renderRateCalculator();
            }
        };

        /* å½ˆçª—é–‹é—œé‚è¼¯ */
        const expenseModal = document.getElementById('expenseModal');
        const closeModal = document.getElementById('closeModal');
        const expenseForm = document.getElementById('expenseForm');
        
        if (addButton) { addButton.onclick = function() { expenseModal.style.display = "flex"; } }
        if (closeModal) { closeModal.onclick = function() { expenseModal.style.display = "none"; expenseForm.reset(); } }
        window.onclick = function(event) { if (event.target == expenseModal) { expenseModal.style.display = "none"; expenseForm.reset(); } }

    </script>
</body>
</html>

