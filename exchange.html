<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSAKA Family Trip</title>
    <!-- 引入 Firebase SDK V8 版本，確保相容性 -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <style>
        /* CSS 樣式：全部採用新色 #955f47 */
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: #f8f8f8;
            color: #382414;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .header {
            width: 100%;
            max-width: 600px;
            background-color: #955f47;
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
        }

        .header a {
            color: white;
            text-decoration: none;
            font-size: 20px;
            margin-right: 15px;
        }

        .header h1 {
            margin: 0;
            font-size: 20px;
            flex-grow: 1;
            text-align: center;
            padding-right: 35px;
        }
        
        .content {
            width: 100%;
            max-width: 600px;
            padding: 20px;
        }

        .summary-box { background-color: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05); margin-bottom: 20px; }
        .total-display { text-align: center; margin-bottom: 20px; }
        .total-display h2 { font-size: 16px; color: #666; margin-bottom: 5px; }
        .total-amount { font-size: 38px; font-weight: bold; color: #382414; }
        .filter-buttons { display: flex; justify-content: center; gap: 10px; margin-bottom: 10px; }
        .filter-btn { background-color: #f0f0f0; color: #382414; border: 1px solid #ddd; border-radius: 50%; width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; font-weight: bold; cursor: pointer; transition: background-color 0.2s; }
        .filter-btn.active { background-color: #955f47; color: white; }

        .account-item { background-color: white; padding: 15px 0; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .account-details { flex-grow: 1; }
        .account-name { font-size: 17px; font-weight: 500; }
        .status-tags { font-size: 12px; margin-top: 5px; }
        .tag-payer, .tag-status { display: inline-block; padding: 2px 6px; border-radius: 4px; font-weight: bold; margin-right: 5px; }
        .tag-payer { background-color: #D7C49E; color: #382414; }
        .tag-paid { background-color: #e6f7d5; color: #5cb85c; }
        .tag-unpaid { background-color: #ffe8e8; color: #f0ad4e; }

        .account-amount { font-size: 20px; font-weight: bold; color: #382414; }

        .add-button-container { width: 100%; max-width: 600px; padding: 20px; position: fixed; bottom: 0; background-color: #f8f8f8; border-top: 1px solid #ddd; text-align: center; z-index: 100; }
        #addButton { width: 90%; padding: 15px; background-color: #382414; color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; }

        .modal { display: none; position: fixed; z-index: 200; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; width: 100%; max-width: 600px; position: absolute; bottom: 0; box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.2); border-top-left-radius: 12px; border-top-right-radius: 12px; padding: 20px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .modal-close { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        
        .input-form-group { margin-bottom: 20px; }
        .input-form-group label { display: block; font-size: 15px; color: #666; margin-bottom: 5px; }
        
        .amount-group { display: flex; align-items: center; border: 1px solid #ddd; border-radius: 6px; }
        .amount-group input { border: none !important; padding: 10px; font-size: 24px !important; flex-grow: 1; }
        .currency-label { padding: 0 10px; font-size: 18px; color: #955f47; font-weight: bold; border-left: 1px solid #ddd; }
        
        .conversion-tip { font-size: 14px; color: #007bff; margin-top: 5px; text-align: right; }

        .rate-calc-box {
            text-align: center;
            padding: 30px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            background-color: white;
            margin-bottom: 20px;
        }

        #jpyInputRate {
            width: 80%;
            padding: 12px;
            font-size: 28px;
            text-align: center;
            border: 3px solid #955f47;
            border-radius: 8px;
            margin-bottom: 20px;
            color: #382414;
        }
    </style>
</head>
<body>
    <div class="header">
        <a href="flight.html">‹</a>
        <h1 id="pageTitle">旅遊記帳本</h1>
    </div>

    <div class="content" id="content">
        <!-- 內容將由 JavaScript 根據 URL 參數動態載入 -->
    </div>

    <div class="add-button-container" id="addButtonContainer" style="display:none;">
        <button id="addButton">＋ 記一筆</button>
    </div>

    <div id="expenseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>新增款項</h2>
                <span class="modal-close" id="closeModal">&times;</span>
            </div>
            
            <form id="expenseForm">
                <div class="input-form-group">
                    <label for="itemName">項目名稱 (例如：超商零食)</label>
                    <input type="text" id="itemName" placeholder="必填" required>
                </div>

                <div class="input-form-group">
                    <label for="jpyAmount">日幣金額</label>
                    <div class="amount-group">
                        <input type="number" id="jpyAmount" placeholder="0" required>
                        <span class="currency-label">JPY</span>
                    </div>
                    <div class="conversion-tip" id="twdConversion">約等於台幣 (TWD): 0</div>
                </div>
                
                <div class="input-form-group">
                    <label>付款人 (未來可點選頭像)</label>
                    <input type="text" value="K" disabled> 
                </div>

                <button type="submit" style="width: 100%; padding: 12px; background-color: #955f47; color: white; border: none; border-radius: 6px; font-size: 16px; margin-top: 10px;">儲存至雲端</button>
            </form>
        </div>
    </div>


    <script>
        // ----------------------------------------------------
        // 【雲端配置區】請勿更動下方結構
        // ----------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyBGmvolsS8AgPfm09qynSVIz5GOcvXDKCM",
            authDomain: "osaka-family-trip.firebaseapp.com",
            databaseURL: "https://osaka-family-trip-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "osaka-family-trip",
            storageBucket: "osaka-family-trip.firebasestorage.app",
            messagingSenderId: "303743481222",
            appId: "1:303743481222:web:e3e4ecb51ff89a3acfe807"
        };
        
        // --- 初始化 Firebase ---
        try {
            firebase.initializeApp(firebaseConfig);
            const database = firebase.database();
            const todoRef = database.ref('travel_budget'); // 預算數據庫路徑
        } catch (error) {
            console.error("Firebase Initialization Error:", error);
            alert("App 啟動失敗！請檢查 Firebase 配置碼是否正確或已啟用 SDK。");
        }
        // ----------------------------------------------------
        
        let currentFilter = 'All'; 
        const currentRate = 0.22; 
        const pageTitle = document.getElementById('pageTitle');
        const contentDiv = document.getElementById('content');
        const addButtonContainer = document.getElementById('addButtonContainer');
        const urlParams = new URLSearchParams(window.location.search);
        const mode = urlParams.get('mode') || 'rate'; 
        
        // ----------------------------------------------------
        // 記帳列表渲染與邏輯
        // ----------------------------------------------------
        function renderBudgetList() {
            pageTitle.textContent = '旅遊記帳本';
            addButtonContainer.style.display = 'flex';
            
            // 這裡載入列表的 HTML
            contentDiv.innerHTML = `
                <div class="summary-box">
                    <div class="total-display">
                        <h2>總金額 (台幣)</h2>
                        <div class="total-amount" id="totalAmount">載入中...</div>
                    </div>
                    <div class="filter-buttons" id="filterButtons">
                        <button class="filter-btn active" data-filter="All">全部</button>
                        <button class="filter-btn" data-filter="K">K</button>
                        <button class="filter-btn" data-filter="M">M</button>
                        <button class="filter-btn" data-filter="E">E</button>
                        <button class="filter-btn" data-filter="J">J</button>
                    </div>
                </div>
                <div class="list-container" id="accountList"></div>
            `;
            
            const accountList = document.getElementById('accountList');
            const filterButtons = document.querySelectorAll('.filter-btn');
            
            function updateDisplay(items) {
                accountList.innerHTML = '';
                
                const itemsArray = items ? Object.keys(items).map(key => ({ ...items[key], key })).reverse() : []; // 反向排序，最新的在最上面
                const filteredData = itemsArray.filter(item => {
                    return currentFilter === 'All' || item.payer === currentFilter;
                });

                // 計算總金額
                const total = filteredData.reduce((sum, item) => sum + item.amountTWD, 0);
                document.getElementById('totalAmount').textContent = `$${total.toLocaleString('en-US')}`;

                filteredData.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'account-item';
                    
                    const statusTagClass = item.paid ? 'tag-paid' : 'tag-unpaid';
                    const statusText = item.paid ? '已付' : '未付';

                    itemDiv.innerHTML = `
                        <div class="account-details">
                            <div class="account-name">${item.name}</div>
                            <div class="status-tags">
                                <span class="tag-payer">${item.payer}</span>
                                <span class="tag-status ${statusTagClass}">${statusText}</span>
                            </div>
                        </div>
                        <div class="account-amount">$${item.amountTWD.toLocaleString('en-US')}</div>
                    `;
                    accountList.appendChild(itemDiv);
                });

                if (filteredData.length === 0) {
                    accountList.innerHTML = '<div style="text-align:center; padding: 40px; color:#999;">目前沒有任何開銷紀錄</div>';
                }
            }
            
            // 監聽 Firebase 數據變化 (雲端同步核心)
            todoRef.on('value', (snapshot) => {
                const items = snapshot.val();
                updateDisplay(items);
            });

            // 篩選按鈕邏輯
            filterButtons.forEach(button => {
                button.addEventListener('click', () => {
                    filterButtons.forEach(btn => btn.classList.remove('active'));
                    currentFilter = button.dataset.filter;
                    button.classList.add('active');
                    // 重新觸發顯示
                    todoRef.once('value').then(snapshot => {
                        updateDisplay(snapshot.val());
                    });
                });
            });
        }
        
        // ----------------------------------------------------
        // JPY 換算邏輯 (點擊新增時的提示)
        // ----------------------------------------------------
        const expenseModal = document.getElementById('expenseModal');
        const twdConversionDiv = document.getElementById('twdConversion');
        const jpyAmountInput = document.getElementById('jpyAmount');
        const expenseForm = document.getElementById('expenseForm');
        
        jpyAmountInput.addEventListener('input', () => {
            const jpyAmount = parseFloat(jpyAmountInput.value) || 0;
            const twdAmount = (jpyAmount * currentRate);
            twdConversionDiv.textContent = `約等於台幣 (TWD): ${Math.round(twdAmount).toLocaleString('en-US')}`;
        });
        
        // ----------------------------------------------------
        // 儲存邏輯 (寫入 Firebase)
        // ----------------------------------------------------
        expenseForm.onsubmit = function(event) {
            event.preventDefault();
            
            const itemName = document.getElementById('itemName').value;
            const jpyAmount = parseFloat(jpyAmountInput.value);
            const twdAmount = Math.round(jpyAmount * currentRate);

            if (itemName && jpyAmount > 0) {
                const newExpense = {
                    name: itemName,
                    amountJPY: jpyAmount,
                    amountTWD: twdAmount,
                    payer: 'K',
                    paid: true,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };
                
                // 核心：寫入 Firebase
                todoRef.push(newExpense);
                
                expenseModal.style.display = "none";
                expenseForm.reset();
                twdConversionDiv.textContent = '約等於台幣 (TWD): 0';
                
            } else {
                alert('請確認項目名稱和金額是否正確！');
            }
        }

        // ----------------------------------------------------
        // 頁面初始化與導航 (換匯計算器邏輯)
        // ----------------------------------------------------
        function renderRateCalculator() {
             pageTitle.textContent = '換匯計算器';
            addButtonContainer.style.display = 'none';
            contentDiv.innerHTML = `
                <div class="rate-calc-box">
                    <div class="currency-display">
                        <span style="font-size: 24px; font-weight: bold;">JPY</span> 輸入日幣金額
                    </div>
                    <input type="number" id="jpyInputRate" placeholder="0">
                    
                    <div class="currency-display">
                        目前匯率：1 JPY 約等於 <span id="currentRate" style="font-weight: bold;">${currentRate}</span> TWD
                    </div>
                    
                    <div class="currency-display" style="margin-top: 25px;">
                        約等於台幣 (TWD): <br>
                        <span id="twdResultRate" style="font-size: 36px; font-weight: bold; color: #1a73e8;">0</span>
                    </div>
                </div>
            `;
            
            const jpyInputRate = document.getElementById('jpyInputRate');
            const twdResultRate = document.getElementById('twdResultRate');
            
            jpyInputRate.addEventListener('input', () => {
                const jpyAmount = parseFloat(jpyInputRate.value) || 0;
                const twdAmount = (jpyAmount * currentRate);
                twdResultRate.textContent = Math.round(twdAmount).toLocaleString('en-US'); 
            });
        }

        if (mode === 'budget') {
            renderBudgetList();
        } else {
            renderRateCalculator();
        }
        
        /* 彈窗開關邏輯 */
        const addButton = document.getElementById('addButton');
        const closeModal = document.getElementById('closeModal');
        
        if (addButton) { addButton.onclick = function() { expenseModal.style.display = "flex"; jpyAmountInput.focus(); } }
        if (closeModal) { closeModal.onclick = function() { expenseModal.style.display = "none"; expenseForm.reset(); twdConversionDiv.textContent = '約等於台幣 (TWD): 0'; } }
        window.onclick = function(event) { if (event.target == expenseModal) { expenseModal.style.display = "none"; expenseForm.reset(); twdConversionDiv.textContent = '約等於台幣 (TWD): 0'; } }

    </script>
</body>
</html>